<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Uzasadnień Orzeczeń</title>
    <!-- Import Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Ikon (do przycisków i UI) -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <!--
        WAŻNE: Reguły Bezpieczeństwa Firebase
        Przejdź do swojej konsoli Firebase -> Firestore Database -> Reguły
        I wklej poniższe reguły (w składni Firestore), aby zezwolić wszystkim 
        na odczyt i zapis w publicznej ścieżce.
    -->
    <!--
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        // Dopasuj ścieżkę do publicznych danych artefaktu
        // artifacts/{appId}/public/data/{wszystkie dokumenty i podkolekcje}
        match /artifacts/{appId}/public/data/{document=**} {
          // Zezwól na odczyt i zapis każdemu (w tym anonimowym)
          allow read, write: if true;
        }
      }
    }
    -->

    <style>
        /* Styl dla ukrytych elementów */
        .hidden {
            display: none;
        }

        /* Styl dla modala */
        #template-modal, #variable-modal {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        /* Styl dla pól formularza */
        fieldset {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #f9fafb;
        }
        legend {
            font-size: 1.25rem;
            font-weight: 600;
            padding: 0 0.5rem;
            color: #111827;
        }
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        label span {
            font-size: 0.75rem;
            color: #6b7280;
            font-family: monospace;
        }
        input[type="text"], input[type="date"], select, textarea {
            width: 100%;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: #111827;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px #bfdbfe;
        }
        input:disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        .btn-secondary {
            background-color: white;
            color: #374151;
            border-color: #d1d5db;
        }
        .btn-secondary:hover {
            background-color: #f9fafb;
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .btn-icon {
            padding: 0.5rem;
            width: 2.25rem;
            height: 2.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Nagłówek i status zapisu -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">Generator Uzasadnień</h1>
            <div class="flex items-center space-x-4">
                <div id="status-indicator" class="flex items-center space-x-2 text-sm text-gray-500">
                    <ion-icon name="cloud-offline-outline" id="status-icon"></ion-icon>
                    <span id="status-text">Łączenie...</span>
                </div>
                <button id="manual-save-btn" class="btn btn-secondary text-sm py-1 px-3">
                    <ion-icon name="save-outline" class="mr-1"></ion-icon>
                    Zapisz
                </button>
            </div>
            <div id="auth-status" class="text-sm text-gray-500">
                <span>UserID: <span id="user-id-display">...</span></span>
            </div>
        </div>
    </header>

    <!-- Główny kontener formularza -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 my-8">
        <div class="bg-white shadow-lg rounded-xl p-6 sm:p-8">
            <form id="main-form">
                
                <!-- SEKCJA: WNIOSEK -->
                <fieldset>
                    <legend>Sekcja "WNIOSEK"</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                        
                        <div>
                            <label for="numer-sprawy">Numer sprawy <span>(numer-sprawy)</span></label>
                            <input type="text" id="numer-sprawy" class="form-field" value="ZN.8321.">
                        </div>
                        
                        <div>
                            <label for="data-wniosku">Data złożenia wniosku <span>(data-wniosku)</span></label>
                            <input type="date" id="data-wniosku" class="form-field">
                        </div>

                        <div>
                            <label for="pan-pani">Pana/Pani <span>(pan-pani)</span></label>
                            <select id="pan-pani" class="form-field">
                                <option value="Pana">Pana</option>
                                <option value="Pani">Pani</option>
                                <option value="małoletniego">małoletniego</option>
                                <option value="małoletniej">małoletniej</option>
                            </select>
                        </div>

                        <div>
                            <label for="imie-nazwisko-odm1">Imię i Nazwisko (odm. Jana K.) <span>(imie-nazwisko-odm1)</span></label>
                            <input type="text" id="imie-nazwisko-odm1" class="form-field">
                        </div>

                        <div>
                            <label for="imie-nazwisko-odm2">Imię i Nazwisko (odm. Janinę K.) <span>(imie-nazwisko-odm2)</span></label>
                            <input type="text" id="imie-nazwisko-odm2" class="form-field">
                        </div>

                        <div>
                            <label for="opiekun-odm">Opiekun (odm. Jana K.) <span>(opiekun-odm)</span></label>
                            <input type="text" id="opiekun-odm" class="form-field">
                        </div>

                        <div>
                            <label for="wniosek-zlozony">Wniosek złożony <span>(wniosek-zlozony)</span></label>
                            <select id="wniosek-zlozony" class="form-field">
                                <option value="pierwszy raz">pierwszy raz</option>
                                <option value="przedłużenie">przedłużenie</option>
                                <option value="pogorszenie">pogorszenie</option>
                                <option value="po przerwie">po przerwie</option>
                                <option value="karta parkingowa">karta parkingowa</option>
                                <option value="był niezaliczony">był niezaliczony</option>
                            </select>
                        </div>
                    </div>
                </fieldset>

                <!-- SEKCJA: Poprzednie orzeczenie (warunkowa) -->
                <fieldset id="sekcja-poprzednie-orzeczenie" class="hidden">
                    <legend>Sekcja "Poprzednie orzeczenie"</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                        
                        <div>
                            <label for="poprz-data-komisji">Data komisji <span>(poprz-data-komisji)</span></label>
                            <input type="date" id="poprz-data-komisji" class="form-field">
                        </div>

                        <div>
                            <label for="poprz-specjalista">Specjalista <span>(poprz-specjalista)</span></label>
                            <select id="poprz-specjalista" class="form-field">
                                <option value="doradca zawodowy">doradca zawodowy</option>
                                <option value="pedagog">pedagog</option>
                                <option value="psycholog">psycholog</option>
                                <option value="pracownik socjalny">pracownik socjalny</option>
                            </select>
                        </div>

                        <!-- Daty zaświadczeń (dynamiczne) -->
                        <div class="md:col-span-2 lg:col-span-1">
                            <label>Daty zaświadczeń lekarskich <span>(poprz-daty-zaswiadczen)</span></label>
                            <div id="daty-zaswiadczen-container" class="space-y-2">
                                <!-- Dynamiczne pola będą dodawane tutaj -->
                            </div>
                            <button type="button" id="btn-add-data-zaswiadczenia" class="btn btn-secondary mt-2 text-sm py-1 px-2">
                                <ion-icon name="add-outline" class="mr-1"></ion-icon>
                                Dodaj datę
                            </button>
                        </div>

                        <div>
                            <label for="poprz-rodzaj-decyzji">Rodzaj decyzji <span>(poprz-rodzaj-decyzji)</span></label>
                            <select id="poprz-rodzaj-decyzji" class="form-field">
                                <option value="orzeczenia Nr">orzeczenia Nr</option>
                                <option value="wyroku w imieniu Rzeczpospolitej Polskiej o Sygn. Akt">wyroku w imieniu Rzeczpospolitej Polskiej o Sygn. Akt</option>
                            </select>
                        </div>

                        <div class="md:col-span-2">
                            <label for="poprz-wydane-przez">Wydane przez <span>(poprz-wydane-przez)</span></label>
                            <div class="flex space-x-2">
                                <select id="poprz-wydane-przez" class="form-field">
                                    <!-- Opcje ładowane z Firebase -->
                                </select>
                                <button type="button" class="btn btn-secondary btn-icon flex-shrink-0" 
                                        data-modal-type="template" 
                                        data-collection="szablonyWydanePrzez"
                                        data-target-select="poprz-wydane-przez"
                                        data-modal-title="Zarządzaj 'Wydane przez'">
                                    <ion-icon name="settings-outline"></ion-icon>
                                </button>
                            </div>
                        </div>

                        <div>
                            <label for="poprz-numer">Numer starego orzeczenia <span>(poprz-numer)</span></label>
                            <input type="text" id="poprz-numer" class="form-field">
                        </div>

                        <div>
                            <label for="poprz-data">Data starego orzeczenia <span>(poprz-data)</span></label>
                            <input type="date" id="poprz-data" class="form-field">
                        </div>

                        <div class="md:col-span-2">
                            <label for="poprz-stopien">Stopień starego orzeczenia <span>(poprz-stopien)</span></label>
                            <select id="poprz-stopien" class="form-field">
                                <option value="lekkiego stopnia niepełnosprawności">lekkiego stopnia niepełnosprawności</option>
                                <option value="umiarkowanego stopnia niepełnosprawności">umiarkowanego stopnia niepełnosprawności</option>
                                <option value="znacznego stopnia niepełnosprawności">znacznego stopnia niepełnosprawności</option>
                                <option value="nie zaliczono dorosły">nie zaliczono (dorosły)</option>
                                <option value="osób niepełnosprawnych">osób niepełnosprawnych</option>
                                <option value="nie zaliczono dziecko">nie zaliczono (dziecko)</option>
                            </select>
                        </div>

                        <div class="md:col-span-2">
                            <label for="poprz-waznosc-data">Ważność starego orzeczenia <span>(poprz-waznosc-data)</span></label>
                            <input type="date" id="poprz-waznosc-data" class="form-field">
                        </div>
                        
                        <div class="flex items-center pt-6">
                            <input type="checkbox" id="poprz-waznosc-trwale" class="form-field h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="poprz-waznosc-trwale" class="ml-2 mb-0">Na stałe <span>(poprz-waznosc-trwale)</span></label>
                        </div>

                    </div>
                </fieldset>

                <!-- SEKCJA: DECYZJA -->
                <fieldset>
                    <legend>Sekcja "Decyzja"</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">

                        <div class="flex items-center pt-6">
                            <input type="checkbox" id="dec-zaocznie" class="form-field h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="dec-zaocznie" class="ml-2 mb-0">Zaocznie <span>(dec-zaocznie)</span></label>
                        </div>

                        <div class="md:col-span-2">
                            <label for="dec-zaliczono-do">Zaliczono do <span>(dec-zaliczono-do)</span></label>
                            <select id="dec-zaliczono-do" class="form-field">
                                <option value="lekkiego stopnia niepełnosprawności">lekkiego stopnia niepełnosprawności</option>
                                <option value="umiarkowanego stopnia niepełnosprawności">umiarkowanego stopnia niepełnosprawności</option>
                                <option value="znacznego stopnia niepełnosprawności">znacznego stopnia niepełnosprawności</option>
                                <option value="nie zaliczono dorosły">nie zaliczono (dorosły)</option>
                                <option value="osób niepełnosprawnych">osób niepełnosprawnych</option>
                                <option value="nie zaliczono dziecko">nie zaliczono (dziecko)</option>
                            </select>
                        </div>
                        
                        <!-- Pole Punkt 1 (przeniesione i naprawione) -->
                        <div id="pole-dec-pkt-1" class="md:col-span-3 hidden">
                            <label for="dec-pkt-1">Punkt 1 (dla lekkiego st.) <span>(dec-pkt-1)</span></label>
                            <div class="flex space-x-2">
                                <select id="dec-pkt-1" class="form-field">
                                    <!-- Opcje ładowane z Firebase -->
                                </select>
                                <button type="button" class="btn btn-secondary btn-icon flex-shrink-0"
                                        data-modal-type="template"
                                        data-collection="szablonyPkt1"
                                        data-target-select="dec-pkt-1"
                                        data-modal-title="Zarządzaj 'Punkt 1'">
                                    <ion-icon name="settings-outline"></ion-icon>
                                </button>
                            </div>
                        </div>

                        <div class="flex items-center pt-6 md:col-start-1">
                            <input type="checkbox" id="dec-pkt-7" class="form-field h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="dec-pkt-7" class="ml-2 mb-0">Punkt 7 <span>(dec-pkt-7)</span></label>
                        </div>

                        <div class="flex items-center pt-6">
                            <input type="checkbox" id="dec-pkt-8" class="form-field h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="dec-pkt-8" class="ml-2 mb-0">Punkt 8 <span>(dec-pkt-8)</span></label>
                        </div>

                        <div class="md:col-span-2">
                            <label for="dec-waznosc-data">Ważność orzeczenia <span>(dec-waznosc-data)</span></label>
                            <input type="date" id="dec-waznosc-data" class="form-field">
                        </div>
                        
                        <div class="flex items-center pt-6">
                            <input type="checkbox" id="dec-waznosc-trwale" class="form-field h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="dec-waznosc-trwale" class="ml-2 mb-0">Na stałe <span>(dec-waznosc-trwale)</span></label>
                        </div>

                        <!-- Symbole -->
                        <div class="md:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-6">
                            <div>
                                <label for="dec-symbol-1">Symbol 1 <span>(dec-symbol-1)</span></label>
                                <select id="dec-symbol-1" class="form-field symbol-select">
                                    <option value="">Brak</option>
                                </select>
                            </div>
                            <div>
                                <label for="dec-symbol-2">Symbol 2 <span>(dec-symbol-2)</span></label>
                                <select id="dec-symbol-2" class="form-field symbol-select">
                                    <option value="">Brak</option>
                                </select>
                            </div>
                            <div>
                                <label for="dec-symbol-3">Symbol 3 <span>(dec-symbol-3)</span></label>
                                <select id="dec-symbol-3" class="form-field symbol-select">
                                    <option value="">Brak</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </fieldset>

                <!-- SEKCJA: UZASADNIENIE -->
                <fieldset>
                    <legend>Sekcja "Uzasadnienie"</legend>
                    <div class="mt-4 space-y-4">
                        <div class="flex flex-wrap gap-2">
                            <button type="button" id="btn-manage-justification-templates" class="btn btn-primary"
                                    data-modal-type="justification"
                                    data-collection="szablonyUzasadnien"
                                    data-modal-title="Zarządzaj szablonami uzasadnień">
                                <ion-icon name="document-text-outline" class="mr-2"></ion-icon>
                                Zarządzaj szablonami
                            </button>
                            <button type="button" id="btn-manage-variables" class="btn btn-secondary"
                                    data-modal-type="variable"
                                    data-collection="zmienneGlobalne"
                                    data-modal-title="Zarządzaj zmiennymi">
                                <ion-icon name="code-working-outline" class="mr-2"></ion-icon>
                                Zarządzaj zmiennymi
                            </button>
                            <button type="button" id="btn-generate-justification" class="btn btn-primary bg-green-600 hover:bg-green-700">
                                <ion-icon name="sparkles-outline" class="mr-2"></ion-icon>
                                Generuj uzasadnienie
                            </button>
                        </div>
                        <div>
                            <label for="wygenerowane-uzasadnienie">Wygenerowane uzasadnienie</label>
                            <textarea id="wygenerowane-uzasadnienie" rows="15" class="form-field font-mono" placeholder="Tutaj pojawi się wygenerowany tekst..."></textarea>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </main>

    <!-- Modal do zarządzania szablonami (Wydane przez, Pkt 1) -->
    <div id="template-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="fixed inset-0" id="template-modal-overlay"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl z-10 max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="template-modal-title" class="text-lg font-semibold">Zarządzanie</h2>
                <button id="template-modal-close" class="btn btn-secondary btn-icon">
                    <ion-icon name="close-outline"></ion-icon>
                </button>
            </div>
            <!-- Modal Body -->
            <div class="p-4 space-y-4 overflow-y-auto">
                <input type="hidden" id="template-modal-doc-id">
                <input type="hidden" id="template-modal-collection">
                <input type="hidden" id="template-modal-target-select">
                
                <!-- Pola dla prostych szablonów (Wydane przez, Pkt 1) -->
                <div id="simple-template-fields">
                    <div>
                        <label for="template-modal-name">Nazwa (opcjonalnie)</label>
                        <input type="text" id="template-modal-name" placeholder="Np. PZON Warszawa" class="w-full">
                    </div>
                    <div>
                        <label for="template-modal-value">Wartość (tekst do wstawienia)</label>
                        <textarea id="template-modal-value" rows="3" class="w-full"></textarea>
                    </div>
                </div>

                <!-- Pola dla szablonów uzasadnień -->
                <div id="justification-template-fields" class="hidden space-y-4">
                     <div>
                        <label for="just-template-modal-name">Nazwa szablonu</label>
                        <input type="text" id="just-template-modal-name" placeholder="Np. Umiarkowany, przedłużenie" class="w-full">
                    </div>
                    <div>
                        <label for="just-template-modal-verification">Weryfikacja (warunek uruchomienia)</label>
                        <input type="text" id="just-template-modal-verification" placeholder="if {dec-zaliczono-do} == 'umiarkowanego stopnia niepełnosprawności' AND {wniosek-zlozony} == 'przedłużenie'" class="w-full font-mono text-sm">
                    </div>
                    <div>
                        <label for="just-template-modal-text">Tekst szablonu</label>
                        <textarea id="just-template-modal-text" rows="10" class="w-full font-mono text-sm" placeholder="Tekst z użyciem {zmiennych} oraz {If(warunek, prawda, fałsz)}..."></textarea>
                    </div>
                </div>

                 <!-- Pola dla zmiennych globalnych -->
                <div id="variable-template-fields" class="hidden space-y-4">
                     <div>
                        <label for="var-template-modal-name">Nazwa zmiennej (bez klamer)</label>
                        <input type="text" id="var-template-modal-name" placeholder="np. nazwa_zespolu" class="w-full font-mono text-sm">
                    </div>
                    <div>
                        <label for="var-template-modal-value">Wartość zmiennej</label>
                        <textarea id="var-template-modal-value" rows="3" class="w-full"></textarea>
                    </div>
                </div>
            </div>
            <!-- Modal Footer -->
            <div class="p-4 border-t flex justify-between">
                <button type="button" id="template-modal-save" class="btn btn-primary">
                    <ion-icon name="save-outline" class="mr-2"></ion-icon>
                    Zapisz
                </button>
                <button type="button" id="template-modal-delete" class="btn btn-danger hidden">
                    <ion-icon name="trash-outline" class="mr-2"></ion-icon>
                    Usuń
                </button>
            </div>
            <!-- Lista istniejących szablonów -->
            <div class="p-4 border-t overflow-y-auto max-h-60">
                <h3 class="font-semibold mb-2">Istniejące pozycje</h3>
                <div id="template-modal-list" class="space-y-2">
                    <!-- Lista ładowana z Firebase -->
                </div>
            </div>
        </div>
    </div>


    <!-- Główny skrypt aplikacji -->
    <script type="module">
        // Importy Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot, 
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            query,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURACJA FIREBASE ---
        const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' 
            ? __firebase_config 
            : null;
            
        let firebaseConfig;

        if (firebaseConfigFromEnv) {
            try {
                firebaseConfig = JSON.parse(firebaseConfigFromEnv);
            } catch (e) {
                console.error("Błąd parsowania konfiguracji Firebase:", e);
                // Użyj prostej widocznej wiadomości zamiast alert()
                const status = document.getElementById('status-text');
                if (status) status.textContent = "BŁĄD KONFIGURACJI!";
            }
        } else {
            // Zastępcza konfiguracja - WPROWADŹ WŁASNĄ
            // UWAGA: Ta konfiguracja jest tylko zastępcza, w rzeczywistym użyciu musi być poprawna.
            firebaseConfig = {
              apiKey: "AIzaSyDSbAFbY--cLcDsqwcfcMakG4vO_VIbcGc",
              authDomain: "uzasadnienia-babd3.firebaseapp.com",
              projectId: "uzasadnienia-babd3",
              storageBucket: "uzasadnienia-babd3.firebasestorage.app",
              messagingSenderId: "873623457594",
              appId: "1:873623457594:web:dcf935e9bd87ee8dd7ca03"
            };
        }
        
        // Zmienne globalne Firebase - DEKLARACJA
        let app, auth, db;
        let userId = null;
        let mainDataDocRef = null;
        let unsubscribeMainData = null;
        let templateUnsubscribeListeners = {}; // Do zarządzania listenerami kolekcji

        // Identyfikator aplikacji (dla ścieżki publicznej)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- ZMIENNE ELEMENTÓW DOM ---
        // (Deklarowane tutaj, przypisywane w DOMContentLoaded)
        let statusIcon, statusText, userIdDisplay, manualSaveBtn;
        let form, formFields;
        let wniosekZlozony, sekcjaPoprzednie, poprzWaznoscTrwale, poprzWaznoscData;
        let decZaocznie, decWaznoscTrwale, decWaznoscData, decZaliczonoDo, poleDecPkt1;
        let btnAddDataZaswiadczenia, datyZaswiadczenContainer;
        
        const symbols = ['01-U', '02-P', '03-L', '04-O', '05-R', '06-E', '07-S', '08-T', '09-M', '10-N', '11-I', '12-C'];
        
        // Elementy Modala
        let templateModal, templateModalOverlay, templateModalClose, templateModalTitle;
        let templateModalDocId, templateModalCollection, templateModalTargetSelect;
        let templateModalSave, templateModalDelete, templateModalList;
        
        // Pola Modala
        let simpleTemplateFields, templateModalName, templateModalValue;
        let justificationTemplateFields, justTemplateModalName, justTemplateModalVerification, justTemplateModalText;
        let variableTemplateFields, varTemplateModalName, varTemplateModalValue;

        // Przyciski generatora
        let btnGenerateJustification, wygenerowaneUzasadnienie;
        
        let listenersAttached = false; // Flaga do kontroli podpięcia listenerów


        // --- FUNKCJE POMOCNICZE ---

        // Funkcja debounce do opóźniania zapisu
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Aktualizacja statusu
        function updateStatus(text, iconName, colorClass = 'text-gray-500') {
            if (statusText && statusIcon) {
                statusText.textContent = text;
                statusIcon.name = iconName;
                statusIcon.className = `${colorClass} transition-all`;
            }
        }
        
        // Wypełnianie listy symboli
        function populateSymbolSelects() {
            const symbolSelects = document.querySelectorAll('.symbol-select');
            symbolSelects.forEach(select => {
                // Wyczyść stare opcje (oprócz pierwszej "Brak")
                while (select.options.length > 1) {
                    select.remove(1);
                }
                // Dodaj nowe
                symbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    select.appendChild(option);
                });
            });
        }

        // --- GŁÓWNA LOGIKA APLIKACJI ---

        // Inicjalizacja Firebase
        async function initializeFirebase() {
            if (!firebaseConfig || !firebaseConfig.projectId) {
                console.error("Konfiguracja Firebase jest nieprawidłowa lub pusta.");
                updateStatus("Brak konfiguracji", "cloud-offline-outline", "text-red-500");
                return;
            }
            try {
                // 1. Inicjalizacja usług i przypisanie do GLOBALNYCH zmiennych
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // 2. Start nasłuchiwania na stan autentykacji
                setupAuthListener();
            } catch (error) {
                console.error("Błąd inicjalizacji Firebase:", error);
                updateStatus("Błąd Firebase", "cloud-offline-outline", "text-red-500");
            }
        }

        // Nasłuchiwanie na stan autentykacji
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Użytkownik jest zalogowany
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    updateStatus("Połączono", "cloud-done-outline", "text-green-500");

                    // Ustawienie referencji do dokumentu
                    const dataPath = `artifacts/${appId}/public/data`;
                    mainDataDocRef = doc(db, dataPath, "orzeczenieData");

                    // Start nasłuchiwania na zmiany w głównym dokumencie
                    startMainDataListener();
                    
                    // Start nasłuchiwania na kolekcje szablonów
                    startTemplateCollectionListeners();
                    
                    // Podepnij listenery aplikacji (formularz, modale)
                    attachAppListeners(); 

                } else {
                    // Użytkownik nie jest zalogowany, próbujemy zalogować
                    userId = null;
                    userIdDisplay.textContent = 'Logowanie...';
                    updateStatus("Logowanie...", "cloud-upload-outline");
                    await login();
                }
            });
        }

        // Funkcja logowania
        async function login() {
            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Błąd logowania:", error);
                updateStatus("Błąd logowania", "cloud-offline-outline", "text-red-500");
            }
        }

        // --- ZARZĄDZANIE DANYMI FORMULARZA ---

        // Zbierz wszystkie dane z formularza
        function getAllFormData() {
            const data = {};
            if (!formFields) return data;
            
            formFields.forEach(field => {
                const id = field.id;
                if (!id) return;

                if (field.type === 'checkbox') {
                    data[id] = field.checked;
                } else if (field.type === 'date') {
                    // Zapisuj daty jako ISO string (YYYY-MM-DD) lub pusty string
                    data[id] = field.value || ""; 
                } else {
                    data[id] = field.value;
                }
            });

            // Obsługa dynamicznych dat zaświadczeń
            const datyZaswiadczen = [];
            if (datyZaswiadczenContainer) {
                datyZaswiadczenContainer.querySelectorAll('input[type="date"]').forEach(input => {
                    if(input.value) {
                        datyZaswiadczen.push(input.value);
                    }
                });
            }
            data['poprz-daty-zaswiadczen'] = datyZaswiadczen;

            return data;
        }

        // Wypełnij formularz danymi z obiektu
        function populateForm(data) {
            if (!data || !formFields) return;

            formFields.forEach(field => {
                const id = field.id;
                if (id && data[id] !== undefined) {
                    if (field.type === 'checkbox') {
                        // Sprawdź, czy wartość jest poprawnie traktowana jako boolean
                        field.checked = !!data[id]; 
                    } else if (field.type === 'date') {
                        field.value = data[id] || "";
                    } else {
                        field.value = data[id];
                    }
                    // Ręczne wywołanie zdarzenia change, aby zaktualizować logikę UI
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });

            // Obsługa dynamicznych dat zaświadczeń
            if (datyZaswiadczenContainer) {
                datyZaswiadczenContainer.innerHTML = ''; // Wyczyść kontener
                if (data['poprz-daty-zaswiadczen'] && Array.isArray(data['poprz-daty-zaswiadczen'])) {
                    data['poprz-daty-zaswiadczen'].forEach(dateStr => {
                        addDateInput(dateStr);
                    });
                }
            }
        }

        // Zapisz dane do Firestore
        let isSaving = false;
        async function saveData() {
            // Dodano sprawdzenie, czy db jest zainicjowane
            if (isSaving || !mainDataDocRef || !db) {
                console.log("Oczekiwanie na inicjalizację bazy danych przed zapisem...");
                return;
            }
            isSaving = true;
            updateStatus("Zapisywanie...", "cloud-upload-outline");

            try {
                const data = getAllFormData();
                await setDoc(mainDataDocRef, data, { merge: true });
                updateStatus("Zapisano", "cloud-done-outline", "text-green-500");
            } catch (error) {
                console.error("Błąd zapisu danych:", error);
                updateStatus("Błąd zapisu", "cloud-offline-outline", "text-red-500");
            } finally {
                isSaving = false;
            }
        }
        const debouncedSave = debounce(saveData, 1000);

        // Nasłuchiwanie na główny dokument
        function startMainDataListener() {
            if (unsubscribeMainData) unsubscribeMainData();
            if (!mainDataDocRef || !db) return; // Upewnienie się, że db jest dostępny

            unsubscribeMainData = onSnapshot(mainDataDocRef, (docSnap) => {
                if (!isSaving) { // Nie nadpisuj formularza, jeśli użytkownik właśnie coś wpisuje
                    if (docSnap.exists()) {
                        populateForm(docSnap.data());
                    } else {
                        console.log("Dokument nie istnieje, tworzenie nowego...");
                        // Tworzenie dokumentu powinno nastąpić tylko po pełnym załadowaniu formularza,
                        // co jest obsługiwane przez pierwsze zdarzenie zapisu.
                        // Po prostu ignorujemy, jeśli dokument nie istnieje, ponieważ
                        // onSnapshot w Firebase Firestore nie tworzy dokumentu, jeśli nie istnieje.
                        // setDoc z merge: true stworzy go przy pierwszym saveData.
                    }
                }
            }, (error) => {
                console.error("Błąd nasłuchiwania na dane:", error);
                updateStatus("Błąd połączenia", "cloud-offline-outline", "text-red-500");
            });
        }
        
        // Nasłuchiwanie na kolekcje szablonów
        function startTemplateCollectionListeners() {
            if (!db) return; // Upewnienie się, że db jest dostępny
            
            // Zamknij stare listenery
            Object.values(templateUnsubscribeListeners).forEach(unsub => unsub());
            templateUnsubscribeListeners = {};
            
            const collectionsToListen = [
                { name: 'szablonyWydanePrzez', target: 'poprz-wydane-przez', field: 'value' },
                { name: 'szablonyPkt1', target: 'dec-pkt-1', field: 'value' }
            ];

            collectionsToListen.forEach(({ name, target, field }) => {
                const collectionRef = collection(db, `artifacts/${appId}/public/data/${name}`);
                templateUnsubscribeListeners[name] = onSnapshot(collectionRef, (querySnapshot) => {
                    const selectElement = document.getElementById(target);
                    if (!selectElement) return;
                    
                    const currentValue = selectElement.value; // Zapisz aktualną wartość
                    
                    // Zapisz opcje oprócz pierwszej ("Brak") dla Pkt 1, jeśli istnieje
                    const optionsToKeep = Array.from(selectElement.options).filter(opt => opt.value === "");
                    selectElement.innerHTML = '';
                    optionsToKeep.forEach(opt => selectElement.appendChild(opt));

                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const option = document.createElement('option');
                        option.value = data[field] || '';
                        option.textContent = data.name || data[field] || `(${doc.id})`;
                        option.dataset.docId = doc.id;
                        selectElement.appendChild(option);
                    });

                    // Przywróć poprzednią wartość, jeśli nadal istnieje
                    if (Array.from(selectElement.options).some(opt => opt.value === currentValue)) {
                        selectElement.value = currentValue;
                    } else {
                        // Jeśli nie istnieje, wybierz pierwszą opcję
                        selectElement.value = selectElement.options[0]?.value || '';
                    }
                    
                }, (error) => {
                    console.error(`Błąd nasłuchiwania na kolekcję ${name}:`, error);
                });
            });
        }


        // --- LOGIKA UI FORMULARZA ---

        function togglePoprzednieOrzeczenie() {
            if (wniosekZlozony.value === 'pierwszy raz') {
                sekcjaPoprzednie.classList.add('hidden');
            } else {
                sekcjaPoprzednie.classList.remove('hidden');
            }
        }

        function togglePoprzWaznosc() {
            if (poprzWaznoscTrwale.checked) {
                poprzWaznoscData.value = '';
                poprzWaznoscData.disabled = true;
            } else {
                poprzWaznoscData.disabled = false;
            }
        }

        function toggleDecWaznosc() {
            if (decWaznoscTrwale.checked) {
                decWaznoscData.value = '';
                decWaznoscData.disabled = true;
            } else {
                decWaznoscData.disabled = false;
            }
        }

        function toggleDecZaocznie() {
            // Logika z oryginalnego zapytania (jeśli zaocznie, zablokuj starą datę)
            if (decZaocznie.checked) {
                poprzWaznoscData.value = '';
                poprzWaznoscData.disabled = true;
            } else {
                // Odblokuj tylko jeśli "na stałe" (stare) nie jest zaznaczone
                if (!poprzWaznoscTrwale.checked) {
                    poprzWaznoscData.disabled = false;
                }
            }
        }

        function toggleDecPkt1() {
            if (decZaliczonoDo.value === 'lekkiego stopnia niepełnosprawności') {
                poleDecPkt1.classList.remove('hidden');
            } else {
                poleDecPkt1.classList.add('hidden');
            }
        }

        // Dodawanie dynamicznych pól dat
        function addDateInput(value = '') {
            const container = document.createElement('div');
            container.className = 'flex items-center space-x-2';
            
            const input = document.createElement('input');
            input.type = 'date';
            input.className = 'form-field flex-grow';
            input.value = value;
            input.addEventListener('change', debouncedSave); // Zapisuj przy zmianie
            input.addEventListener('input', debouncedSave); 

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-icon flex-shrink-0 text-sm';
            removeBtn.innerHTML = '<ion-icon name="remove-outline"></ion-icon>';
            removeBtn.addEventListener('click', () => {
                container.remove();
                debouncedSave(); // Zapisz po usunięciu
            });

            container.appendChild(input);
            container.appendChild(removeBtn);
            datyZaswiadczenContainer.appendChild(container);
        }

        // --- ZARZĄDZANIE SZABLONAMI (MODAL) ---

        function openModal(event) {
            const btn = event.currentTarget;
            const modalType = btn.dataset.modalType;
            const collectionName = btn.dataset.collection;
            const modalTitle = btn.dataset.modalTitle;
            const targetSelectId = btn.dataset.targetSelect || '';

            // Resetuj formularz modala
            templateModalDocId.value = '';
            templateModalName.value = '';
            templateModalValue.value = '';
            justTemplateModalName.value = '';
            justTemplateModalVerification.value = '';
            justTemplateModalText.value = '';
            varTemplateModalName.value = '';
            varTemplateModalValue.value = '';
            templateModalDelete.classList.add('hidden');
            
            // Ustaw globalne atrybuty modala
            templateModalCollection.value = collectionName;
            templateModalTitle.textContent = modalTitle;
            templateModalTargetSelect.value = targetSelectId;
            
            // Pokaż odpowiednie pola
            simpleTemplateFields.classList.add('hidden');
            justificationTemplateFields.classList.add('hidden');
            variableTemplateFields.classList.add('hidden');

            if (modalType === 'template') {
                simpleTemplateFields.classList.remove('hidden');
            } else if (modalType === 'justification') {
                justificationTemplateFields.classList.remove('hidden');
            } else if (modalType === 'variable') {
                variableTemplateFields.classList.remove('hidden');
            }
            
            // Załaduj listę dla tej kolekcji
            loadTemplateList(collectionName);

            templateModal.classList.remove('hidden');
        }

        function closeModal() {
            templateModal.classList.add('hidden');
            // Ponowne załadowanie list rozwijanych po zamknięciu modala (wymusi aktualizację z Firebase)
            startTemplateCollectionListeners();
        }

        async function loadTemplateList(collectionName) {
            if (!db) {
                templateModalList.innerHTML = '<div class="text-red-500">Błąd: Brak połączenia z bazą danych.</div>';
                return;
            }
            templateModalList.innerHTML = '<div class="text-gray-500">Ładowanie...</div>';
            const collectionRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
            
            try {
                const querySnapshot = await getDocs(query(collectionRef));
                templateModalList.innerHTML = '';
                if (querySnapshot.empty) {
                    templateModalList.innerHTML = '<div class="text-gray-500">Brak zapisanych pozycji.</div>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'p-2 border rounded-md cursor-pointer hover:bg-gray-100 flex justify-between items-center';
                    
                    // Wyświetl nazwę lub wartość
                    let displayName = '';
                    if (data.name) {
                        displayName = data.name;
                    } else if (collectionName === 'szablonyWydanePrzez' || collectionName === 'szablonyPkt1') {
                        displayName = (data.value || doc.id).substring(0, 50) + ((data.value || doc.id).length > 50 ? '...' : '');
                    } else if (collectionName === 'szablonyUzasadnien') {
                        displayName = (data.name || data.text || doc.id).substring(0, 50) + ((data.name || data.text || doc.id).length > 50 ? '...' : '');
                    } else if (collectionName === 'zmienneGlobalne') {
                        displayName = (data.name || doc.id) + ' = ' + (data.value || '').substring(0, 30) + ((data.value || '').length > 30 ? '...' : '');
                    } else {
                        displayName = doc.id;
                    }
                    div.textContent = displayName;

                    div.addEventListener('click', () => {
                        // Wypełnij formularz modala danymi
                        templateModalDocId.value = doc.id;
                        
                        // Pola proste
                        templateModalName.value = data.name || '';
                        templateModalValue.value = data.value || '';
                        
                        // Pola uzasadnień
                        justTemplateModalName.value = data.name || '';
                        justTemplateModalVerification.value = data.verification || '';
                        justTemplateModalText.value = data.text || '';

                        // Pola zmiennych
                        varTemplateModalName.value = data.name || '';
                        varTemplateModalValue.value = data.value || '';

                        templateModalDelete.classList.remove('hidden');
                    });
                    templateModalList.appendChild(div);
                });
            } catch (error) {
                console.error("Błąd ładowania listy:", error);
                templateModalList.innerHTML = '<div class="text-red-500">Błąd ładowania listy.</div>';
            }
        }

        async function saveTemplate() {
            if (!db) return;

            const collectionName = templateModalCollection.value;
            const docId = templateModalDocId.value;
            const collectionRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
            
            let data = {};
            
            if (!simpleTemplateFields.classList.contains('hidden')) {
                // Walidacja dla prostych pól (Wydane przez, Pkt 1)
                if (!templateModalValue.value) {
                    alert("Wartość (tekst do wstawienia) jest wymagana.");
                    return;
                }
                data = { name: templateModalName.value, value: templateModalValue.value };
            } else if (!justificationTemplateFields.classList.contains('hidden')) {
                // Walidacja dla uzasadnień
                 if (!justTemplateModalName.value || !justTemplateModalText.value) {
                    alert("Nazwa szablonu i Tekst szablonu są wymagane.");
                    return;
                }
                data = { name: justTemplateModalName.value, verification: justTemplateModalVerification.value, text: justTemplateModalText.value };
            } else if (!variableTemplateFields.classList.contains('hidden')) {
                // Walidacja dla zmiennych
                if (!varTemplateModalName.value || !varTemplateModalValue.value) {
                    alert("Nazwa zmiennej i Wartość zmiennej są wymagane.");
                    return;
                }
                data = { name: varTemplateModalName.value, value: varTemplateModalValue.value };
            } else {
                return;
            }

            try {
                if (docId) {
                    // Aktualizuj
                    const docRef = doc(db, collectionRef.path, docId);
                    await updateDoc(docRef, data);
                    // Ręczne wyczyszczenie formularza po edycji
                    templateModalDocId.value = '';
                } else {
                    // Dodaj nowy
                    await addDoc(collectionRef, data);
                }
                closeModal();
            } catch (error) {
                console.error("Błąd zapisu szablonu:", error);
                // Zamieniono alert na bardziej czytelną obsługę błędu
                const modalFooter = templateModal.querySelector('.p-4.border-t.flex.justify-between');
                const errorMsg = document.createElement('div');
                errorMsg.className = 'text-sm text-red-500 p-2 bg-red-100 rounded-lg';
                errorMsg.textContent = "Nie udało się zapisać szablonu. Sprawdź konsolę, aby zobaczyć szczegóły.";
                modalFooter.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 5000);
            }
        }

        async function deleteTemplate() {
            if (!db) return;
            const collectionName = templateModalCollection.value;
            const docId = templateModalDocId.value;
            
            if (!docId) return;

            // Zastąpienie alert() i confirm()
            const isConfirmed = confirm('Czy na pewno chcesz usunąć tę pozycję?');

            if (!isConfirmed) return;

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/${collectionName}`, docId);
                await deleteDoc(docRef);
                closeModal();
            } catch (error) {
                console.error("Błąd usuwania szablonu:", error);
                alert("Nie udało się usunąć szablonu. Sprawdź konsolę.");
            }
        }
        
        // --- GENERATOR UZASADNIEŃ ---
        
        async function generateJustification() {
            if (!db) {
                wygenerowaneUzasadnienie.value = "Błąd: Brak połączenia z bazą danych. Upewnij się, że Firebase jest poprawnie skonfigurowane i zalogowane.";
                return;
            }

            wygenerowaneUzasadnienie.value = "Generowanie...";
            
            // 1. Zbierz wszystkie dane z formularza
            const formData = getAllFormData();
            
            // 2. Zbierz zmienne globalne
            const globalVars = {};
            try {
                const collectionRef = collection(db, `artifacts/${appId}/public/data/zmienneGlobalne`);
                const querySnapshot = await getDocs(query(collectionRef));
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Zmienna musi mieć nazwę!
                    if (data.name) {
                        globalVars[data.name] = data.value || '';
                    }
                });
            } catch (e) {
                console.error("Błąd ładowania zmiennych globalnych:", e);
            }
            
            // Połącz dane formularza i zmienne globalne (formularz ma priorytet)
            const allData = { ...globalVars, ...formData };
            
            // 3. Pobierz wszystkie szablony uzasadnień
            let matchingTemplateText = "Nie znaleziono pasującego szablonu.";
            try {
                const collectionRef = collection(db, `artifacts/${appId}/public/data/szablonyUzasadnien`);
                // UWAGA: Nie używamy orderBy, aby uniknąć konieczności indeksowania.
                const querySnapshot = await getDocs(query(collectionRef));
                
                for (const doc of querySnapshot.docs) {
                    const template = doc.data();
                    if (template.verification && template.text) {
                        // 4. Sprawdź pole "weryfikacja"
                        if (evaluateVerification(template.verification, allData)) {
                            // 5. Jeśli pasuje, przetwórz tekst
                            matchingTemplateText = processTemplate(template.text, allData);
                            break; // Użyj pierwszego pasującego szablonu
                        }
                    }
                }
            } catch (e) {
                console.error("Błąd przetwarzania szablonów:", e);
                matchingTemplateText = "Błąd podczas przetwarzania szablonów. Sprawdź konsolę.";
            }
            
            wygenerowaneUzasadnienie.value = matchingTemplateText;
        }
        
        function evaluateLogic(expression, data) {
            // Prosty ewaluator dla {If(...)}
            // {If(warunek, prawda, fałsz)}
            const ifRegex = /\{If\((.*?),(.*?),(.*?)\)\}/g;
            
            // Użyj pętli while, aby obsłużyć zagnieżdżone lub wielokrotne If
            let processedExpression = expression;
            let match;
            
            while ((match = ifRegex.exec(processedExpression)) !== null) {
                // Ustawienie lastIndex na 0 po wywołaniu exec z g
                if (match.index === ifRegex.lastIndex) {
                    ifRegex.lastIndex++;
                }
                
                const [fullMatch, condition, trueVal, falseVal] = match;
                
                // Usunięcie otwierających/zamykających klamer ze zmiennych wewnątrz If
                const cleanedTrueVal = trueVal.trim().startsWith('{') ? trueVal.trim().slice(1, -1) : trueVal;
                const cleanedFalseVal = falseVal.trim().startsWith('{') ? falseVal.trim().slice(1, -1) : falseVal;

                if (evaluateVerification(condition, data)) {
                    // UWAGA: Trzeba usunąć { i } z otoczenia, które dodaliśmy później
                    processedExpression = processedExpression.replace(fullMatch, processTemplate(cleanedTrueVal, data)); 
                } else {
                    processedExpression = processedExpression.replace(fullMatch, processTemplate(cleanedFalseVal, data)); 
                }
                ifRegex.lastIndex = 0; // Resetuj indeks, aby ponowić pętlę na zmienionym stringu
            }

            return processedExpression;
        }

        function evaluateVerification(verification, data) {
            // Zastąp zmienne {nazwa} ich wartościami w otoczonych apostrofach, 
            // aby były traktowane jako ciągi znaków w JS.
            let expression = verification.replace(/\{([^}]+)\}/g, (match, varName) => {
                const value = data[varName.trim()] || "";
                // Escapowanie apostrofów w wartościach dla bezpiecznego użycia w stringu JS
                return `'${String(value).replace(/'/g, "\\'")}'`; 
            });

            // Zastąp operatory
            expression = expression.replace(/ AND /gi, ' && ').replace(/ OR /gi, ' || ').replace(/ = /gi, ' == ');

            try {
                // Użyj Function, aby bezpiecznie obliczyć wyrażenie
                // Użycie Function jest bezpieczniejsze niż eval()
                return new Function(`return ${expression}`)();
            } catch (e) {
                console.error(`Błąd ewaluacji weryfikacji: ${verification}`, e);
                console.log(`Przetworzone wyrażenie: ${expression}`);
                return false;
            }
        }
        
        function processTemplate(text, data) {
            let processedText = text;
            
            // 1. Przetwórz logikę {If(...)}
            processedText = evaluateLogic(processedText, data);
            
            // 2. Zastąp zmienne {nazwa} (które nie są If)
            processedText = processedText.replace(/\{([^}]+)\}/g, (match, varName) => {
                // To jest fallback, który złapie wszystko, co nie zostało złapane przez evaluateLogic
                if (varName.trim().toLowerCase().startsWith('if(')) {
                    return match; // Zostaw nienaruszone, jeśli wygląda na If
                }
                const value = data[varName.trim()];
                return value !== undefined ? value : ''; // Zostaw puste, jeśli nie ma danych
            });
            
            return processedText;
        }

        // --- INICJALIZACJA EVENT LISTENERÓW ---

        // Funkcja do podpięcia listenerów po pomyślnej autentykacji
        function attachAppListeners() {
            if (listenersAttached) return; 
            console.log("Podpinanie listenerów aplikacji...");

            // Zapisywanie danych
            // Podpięcie listenerów formularza na input/change, które wywołują debouncedSave
            document.querySelectorAll('.form-field').forEach(field => {
                field.addEventListener('input', debouncedSave);
                field.addEventListener('change', debouncedSave);
            });
            manualSaveBtn.addEventListener('click', (e) => {
                e.preventDefault();
                saveData(); // Wymuś zapis
            });
            
            // Dynamiczne daty
            btnAddDataZaswiadczenia.addEventListener('click', () => addDateInput());

            // Listenery Modala (Przyciski Zarządzania)
            document.querySelectorAll('[data-modal-type]').forEach(btn => {
                // Upewnij się, że nie podpinasz więcej niż raz
                if (btn.dataset.listenerAttached !== 'true') {
                    btn.addEventListener('click', openModal);
                    btn.dataset.listenerAttached = 'true';
                }
            });
            templateModalClose.addEventListener('click', closeModal);
            templateModalOverlay.addEventListener('click', closeModal);
            templateModalSave.addEventListener('click', saveTemplate);
            templateModalDelete.addEventListener('click', deleteTemplate);
            
            // Generator
            btnGenerateJustification.addEventListener('click', generateJustification);
            
            listenersAttached = true;
            console.log("Listenery aplikacji podpięte.");
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            // --- PRZYPISANIE ELEMENTÓW DOM ---
            statusIcon = document.getElementById('status-icon');
            statusText = document.getElementById('status-text');
            userIdDisplay = document.getElementById('user-id-display');
            manualSaveBtn = document.getElementById('manual-save-btn');
            
            form = document.getElementById('main-form');
            // Poprawne zebranie wszystkich pól formularza (input, select, textarea)
            formFields = document.querySelectorAll('#main-form .form-field:not(button):not([data-modal-type])');

            wniosekZlozony = document.getElementById('wniosek-zlozony');
            sekcjaPoprzednie = document.getElementById('sekcja-poprzednie-orzeczenie');
            poprzWaznoscTrwale = document.getElementById('poprz-waznosc-trwale');
            poprzWaznoscData = document.getElementById('poprz-waznosc-data');
            decZaocznie = document.getElementById('dec-zaocznie');
            decWaznoscTrwale = document.getElementById('dec-waznosc-trwale');
            decWaznoscData = document.getElementById('dec-waznosc-data');
            decZaliczonoDo = document.getElementById('dec-zaliczono-do');
            poleDecPkt1 = document.getElementById('pole-dec-pkt-1');
            btnAddDataZaswiadczenia = document.getElementById('btn-add-data-zaswiadczenia');
            datyZaswiadczenContainer = document.getElementById('daty-zaswiadczen-container');
            
            // Elementy Modala
            templateModal = document.getElementById('template-modal');
            templateModalOverlay = document.getElementById('template-modal-overlay');
            templateModalClose = document.getElementById('template-modal-close');
            templateModalTitle = document.getElementById('template-modal-title');
            templateModalDocId = document.getElementById('template-modal-doc-id');
            templateModalCollection = document.getElementById('template-modal-collection');
            templateModalTargetSelect = document.getElementById('template-modal-target-select');
            templateModalSave = document.getElementById('template-modal-save');
            templateModalDelete = document.getElementById('template-modal-delete');
            templateModalList = document.getElementById('template-modal-list');
            
            simpleTemplateFields = document.getElementById('simple-template-fields');
            templateModalName = document.getElementById('template-modal-name');
            templateModalValue = document.getElementById('template-modal-value');
            
            justificationTemplateFields = document.getElementById('justification-template-fields');
            justTemplateModalName = document.getElementById('just-template-modal-name');
            justTemplateModalVerification = document.getElementById('just-template-modal-verification');
            justTemplateModalText = document.getElementById('just-template-modal-text');

            variableTemplateFields = document.getElementById('variable-template-fields');
            varTemplateModalName = document.getElementById('var-template-modal-name');
            varTemplateModalValue = document.getElementById('var-template-modal-value');

            // Przyciski generatora
            btnGenerateJustification = document.getElementById('btn-generate-justification');
            wygenerowaneUzasadnienie = document.getElementById('wygenerowane-uzasadnienie');
            
            // --- INICJALIZACJA ---
            
            // GŁÓWNA POPRAWKA: Uruchomienie inicjalizacji Firebase
            initializeFirebase(); 
            populateSymbolSelects();

            // Logika UI formularza (zostaje bez zmian, bo nie zależy od Firebase)
            wniosekZlozony.addEventListener('change', togglePoprzednieOrzeczenie);
            poprzWaznoscTrwale.addEventListener('change', togglePoprzWaznosc);
            decWaznoscTrwale.addEventListener('change', toggleDecWaznosc);
            decZaocznie.addEventListener('change', toggleDecZaocznie);
            decZaliczonoDo.addEventListener('change', toggleDecPkt1);
            
            // UWAGA: Listenery formularza są podpinane w attachAppListeners() po autentykacji, 
            // aby zapewnić, że zapis działa prawidłowo.
        });

    </script>
</body>
</html>