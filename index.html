<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Uzasadnień</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .modal { display: none; }
        .modal.active { display: flex; }
        /* Użycie Inter dla lepszej czytelności */
        body { font-family: "Inter", sans-serif; }
        /* Ulepszone style dla widżetu zmiennych na dużych ekranach */
        @media (min-width: 1024px) {
            #lista-zmiennych-widget {
                position: sticky;
                top: 20px;
                max-height: calc(100vh - 40px); /* 40px marginesu na górze/dole */
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
    
    <!-- PRZYCISK ZARZĄDZAJ ZMIENNYMI (stały, prawy górny róg) -->
    <button id="zarzadzaj-zmiennymi-btn-fixed" class="fixed top-2 right-2 z-50 py-1 px-3 
        bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-lg shadow-xl 
        text-xs sm:text-sm transition duration-150 ease-in-out transform hover:scale-105">
        Zarządzaj Zmiennymi
    </button>

    <div class="container mx-auto p-2 sm:p-4">
        <p id="status-text" class="text-center text-sm sm:text-lg font-semibold mb-4 text-gray-700 pt-8 sm:pt-0">Łączenie...</p>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
            
            <!-- Główna Kolumna (Dane Wniosku/Decyzji + Uzasadnienie) -->
            <div class="lg:col-span-3 grid grid-cols-1 gap-4 order-2 lg:order-1">
                
                <!-- Sekcja WNIOSEK -->
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-xl sm:text-2xl font-bold mb-3 border-b pb-1 text-gray-800">WNIOSEK</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="md:col-span-1 flex items-end space-x-2">
                            <div class="flex-grow">
                                <label for="numer-sprawy" class="block text-xs sm:text-sm font-medium text-gray-700">Numer sprawy (numer-sprawy)</label>
                                <input type="text" id="numer-sprawy" value="ZN.8321." class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                            </div>
                            <button id="wyszukaj" class="py-1 px-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 text-sm h-8 mt-1 shadow-md transition duration-150">Wyszukaj</button>
                        </div>
                        <div>
                            <label for="data-zlozenia-wniosku" class="block text-xs sm:text-sm font-medium text-gray-700">Data złożenia wniosku (data-zlozenia-wniosku)</label>
                            <input type="text" id="data-zlozenia-wniosku" placeholder="dd.mm.rrrr" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        </div>
                        <div>
                            <label for="plec" class="block text-xs sm:text-sm font-medium text-gray-700">Pana/Pani (plec)</label>
                            <select id="plec" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                                <option>Pana</option>
                                <option>Pani</option>
                                <option>małoletniego</option>
                                <option>małoletniej</option>
                            </select>
                        </div>
                        <div>
                            <label for="imie-nazwisko-dopelniacz" class="block text-xs sm:text-sm font-medium text-gray-700">Imię i Nazwisko orzekanego (kogo, czego?) (imie-nazwisko-dopelniacz)</label>
                            <input type="text" id="imie-nazwisko-dopelniacz" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        </div>
                        <div>
                            <label for="imie-nazwisko-biernik" class="block text-xs sm:text-sm font-medium text-gray-700">Imię i Nazwisko orzekanego (kogo, co?) (imie-nazwisko-biernik)</label>
                            <input type="text" id="imie-nazwisko-biernik" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        </div>
                        <div>
                            <label for="opiekun-dopelniacz" class="block text-xs sm:text-sm font-medium text-gray-700">Opiekun (kogo, czego?) (opiekun-dopelniacz)</label>
                            <input type="text" id="opiekun-dopelniacz" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        </div>
                        <div>
                            <label for="wniosek-zlozony" class="block text-xs sm:text-sm font-medium text-gray-700">Wniosek złożony (wniosek-zlozony)</label>
                            <select id="wniosek-zlozony" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                                <option value="pierwszy raz">pierwszy raz</option>
                                <option value="przedłużenie">przedłużenie</option>
                                <option value="pogorszenie">pogorszenie</option>
                                <option value="po przerwie">po przerwie</option>
                                <option value="karta parkingowa">karta parkingowa</option>
                                <option value="był niezaliczony">był niezaliczony</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Sekcja Poprzednie orzeczenie -->
                <div id="sekcja-poprzednie-orzeczenie" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200 hidden">
                    <h2 class="text-xl sm:text-2xl font-bold mb-3 border-b pb-1 text-gray-800">POPPRZEDNIE ORZECZENIE</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label for="rodzaj-decyzji" class="block text-xs sm:text-sm font-medium text-gray-700">Rodzaj decyzji (rodzaj-decyzji)</label>
                            <select id="rodzaj-decyzji" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                                <option>orzeczenia Nr</option>
                                <option>wyroku w imieniu Rzeczpospolitej Polskiej o Sygn. Akt</option>
                            </select>
                        </div>
                        <div>
                            <label for="wydane-przez-lista" class="block text-xs sm:text-sm font-medium text-gray-700">Wydane przez (wydane-przez-lista)</label>
                            <div class="flex items-center">
                                <select id="wydane-przez-lista" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></select>
                                <button id="zarzadzaj-wydane-przez" class="ml-2 py-1 px-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 text-sm shadow-md transition duration-150">Zarządzaj</button>
                            </div>
                        </div>
                        <div>
                            <label for="numer-starego-orzeczenia" class="block text-xs sm:text-sm font-medium text-gray-700">Numer starego orzeczenia (numer-starego-orzeczenia)</label>
                            <input type="text" id="numer-starego-orzeczenia" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        </div>
                        <div>
                            <label for="data-starego-orzeczenia" class="block text-xs sm:text-sm font-medium text-gray-700">Data starego orzeczenia (data-starego-orzeczenia)</label>
                            <input type="text" id="data-starego-orzeczenia" placeholder="dd.mm.rrrr" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        </div>
                        <div>
                            <label for="stopien-starego-orzeczenia" class="block text-xs sm:text-sm font-medium text-gray-700">Stopień starego orzeczenia (stopien-starego-orzeczenia)</label>
                            <select id="stopien-starego-orzeczenia" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                                <option>lekkiego stopnia niepełnosprawności</option>
                                <option>umiarkowanego stopnia niepełnosprawności</option>
                                <option>znacznego stopnia niepełnosprawności</option>
                                <option>nie zaliczono dorosły</option>
                                <option>osób niepełnosprawnych</option>
                                <option>nie zaliczono dziecko</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="waznosc-starego-data" class="block text-xs sm:text-sm font-medium text-gray-700">Ważność starego orzeczenia (waznosc-starego-data)</label>
                            <input type="text" id="waznosc-starego-data" placeholder="dd.mm.rrrr" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 flex-grow transition duration-150">
                            <input type="checkbox" id="waznosc-starego-trwale" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="waznosc-starego-trwale" class="block text-xs sm:text-sm text-gray-900 whitespace-nowrap">Na stałe</label>
                        </div>
                    </div>
                </div>

                <!-- Sekcja Decyzja -->
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-xl sm:text-2xl font-bold mb-3 border-b pb-1 text-gray-800">DECYZJA</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label for="data-komisji" class="block text-xs sm:text-sm font-medium text-gray-700">Data komisji (data-komisji)</label>
                            <input type="text" id="data-komisji" placeholder="dd.mm.rrrr" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        </div>
                        <div>
                            <label for="specjalista" class="block text-xs sm:text-sm font-medium text-gray-700">Specjalista (specjalista)</label>
                            <select id="specjalista" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                                <option>doradca zawodowy</option>
                                <option>pedagog</option>
                                <option>psycholog</option>
                                <option>pracownik socjalny</option>
                            </select>
                        </div>
                        
                        <!-- Daty zaświadczeń - użycie grid-cols-1 dla lepszej kompaktowości -->
                        <div class="md:col-span-2">
                            <label class="block text-xs sm:text-sm font-medium text-gray-700">Daty zaświadczeń lekarskich (daty-zaswiadczen)</label>
                            <div id="daty-zaswiadczen-lekarskich-kontener" class="grid grid-cols-1 gap-2">
                                 <!-- Pola daty są dodawane dynamicznie -->
                            </div>
                            <button id="dodaj-date-zaswiadczenia" class="mt-2 py-1 px-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs shadow-md transition duration-150">Dodaj datę</button>
                        </div>
                        
                        <div class="flex flex-col space-y-2 pt-2 md:pt-0">
                            <div class="flex items-center">
                                <input type="checkbox" id="zaocznie" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="zaocznie" class="ml-2 block text-sm text-gray-900">Zaocznie (zaocznie)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="odmowa-wydania" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                <label for="odmowa-wydania" class="ml-2 block text-sm text-gray-900">Odmowa wydania orzeczenia (odmowa-wydania)</label>
                            </div>
                        </div>

                        <div>
                            <label for="zaliczono-do" class="block text-xs sm:text-sm font-medium text-gray-700">Zaliczono do (zaliczono-do)</label>
                            <select id="zaliczono-do" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                                <option>lekkiego stopnia niepełnosprawności</option>
                                <option>umiarkowanego stopnia niepełnosprawności</option>
                                <option>znacznego stopnia niepełnosprawności</option>
                                <option>nie zaliczono dorosły</option>
                                <option>osób niepełnosprawnych</option>
                                <option>nie zaliczono dziecko</option>
                            </select>
                        </div>
                        <!-- Checkboxy punktów (w jednej kolumnie na urządzeniach mobilnych) -->
                        <div class="grid grid-cols-3 gap-2 col-span-1 md:col-span-2">
                            <div class="flex items-center pt-2">
                                <input type="checkbox" id="punkt1-checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="punkt1-checkbox" class="ml-2 block text-xs sm:text-sm text-gray-900 whitespace-nowrap">Punkt 1 (punkt1)</label>
                            </div>
                            <div class="flex items-center pt-2">
                                <input type="checkbox" id="punkt7" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="punkt7" class="ml-2 block text-xs sm:text-sm text-gray-900 whitespace-nowrap">Punkt 7 (punkt7)</label>
                            </div>
                            <div class="flex items-center pt-2">
                                <input type="checkbox" id="punkt8" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="punkt8" class="ml-2 block text-xs sm:text-sm text-gray-900 whitespace-nowrap">Punkt 8 (punkt8)</label>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <label for="waznosc-nowego-data" class="block text-xs sm:text-sm font-medium text-gray-700">Ważność orzeczenia (waznosc-nowego-data)</label>
                            <input type="text" id="waznosc-nowego-data" placeholder="dd.mm.rrrr" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 flex-grow transition duration-150">
                            <input type="checkbox" id="waznosc-nowego-trwale" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="waznosc-nowego-trwale" class="block text-xs sm:text-sm text-gray-900 whitespace-nowrap">Na stałe</label>
                        </div>
                         <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700">Symbole</label>
                            <div class="grid grid-cols-3 gap-2">
                                 <select id="symbol-1" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                                    <option></option> <option>01-U</option> <option>02-P</option> <option>03-L</option> <option>04-O</option> <option>05-R</option> <option>06-E</option> <option>07-S</option> <option>08-T</option> <option>09-M</option> <option>10-N</option> <option>11-I</option> <option>12-C</option>
                                 </select>
                                 <select id="symbol-2" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                                     <option></option> <option>01-U</option> <option>02-P</option> <option>03-L</option> <option>04-O</option> <option>05-R</option> <option>06-E</option> <option>07-S</option> <option>08-T</option> <option>09-M</option> <option>10-N</option> <option>11-I</option> <option>12-C</option>
                                 </select>
                                 <select id="symbol-3" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                                    <option></option> <option>01-U</option> <option>02-P</option> <option>03-L</option> <option>04-O</option> <option>05-R</option> <option>06-E</option> <option>07-S</option> <option>08-T</option> <option>09-M</option> <option>10-N</option> <option>11-I</option> <option>12-C</option>
                                 </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sekcja Przyciski Główne (zostawiam tylko Zapisz) -->
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg flex justify-center gap-4 border border-gray-200">
                     <button id="zapisz" class="py-2 px-6 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold rounded-lg hover:from-green-600 hover:to-green-700 text-sm shadow-lg transition duration-150">Zapisz</button>
                </div>

                <!-- Sekcja Uzasadnienie -->
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-2xl border-2 border-indigo-400">
                    <h2 class="text-xl sm:text-2xl font-bold mb-3 border-b pb-1 text-gray-800">UZASADNIENIE</h2>
                    <div class="flex justify-end mb-3">
                        <button id="zarzadzaj-szablonami-btn" class="py-1 px-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg text-sm shadow-md transition duration-150">Zarządzaj Szablonami</button>
                    </div>
                    <!-- Dodanie nasłuchiwania na click dla kopiowania -->
                    <textarea id="wygenerowane-uzasadnienie" rows="15" class="mt-1 block w-full border-2 border-indigo-200 rounded-lg shadow-inner py-2 px-3 bg-gray-50 text-sm cursor-pointer text-gray-900 focus:border-indigo-500 transition duration-150" readonly placeholder="Kliknij, aby skopiować uzasadnienie do schowka."></textarea>
                </div>
            </div>

            <!-- Prawa Kolumna (Lista Zmiennych) -->
            <div id="lista-zmiennych-widget" class="lg:col-span-1 order-1 lg:order-2 bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-lg font-bold mb-3 border-b pb-1 text-gray-800">Dostępne Zmienne Niestandardowe</h2>
                <div id="zmienne-widget-content" class="space-y-2">
                    <p class="text-sm text-gray-500">Brak zmiennych lub ładowanie...</p>
                </div>
                <div class="mt-4 border-t pt-2">
                    <h3 class="text-sm font-semibold text-gray-700">Zmienne Systemowe (przykłady):</h3>
                    <p class="text-xs text-gray-500">**data-zlozenia-wniosku**, **plec**, **imie-nazwisko-dopelniacz**, **zaliczono-do**, **punkt7** (true/false), **daty-zaswiadczen** (lista), itd.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Zarządzania Szablonami Uzasadnień -->
    <div id="modal-szablony" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 md:w-2/3 lg:w-1/2 p-4 sm:p-6">
            <h3 class="text-xl sm:text-2xl font-bold mb-4 text-gray-800">Zarządzaj Szablonami Uzasadnień</h3>
            <div class="max-h-80 sm:max-h-96 overflow-y-auto" id="lista-szablonow"></div>
            <div class="mt-4 border-t pt-4">
                <input type="hidden" id="szablon-id">
                <input type="text" id="szablon-nazwa" placeholder="Nazwa szablonu" class="block w-full border-gray-300 rounded-lg shadow-sm mb-2 p-2 text-sm focus:border-indigo-500">
                
                <!-- ZMIENIONE POLA WERYFIKACJI -->
                <div class="grid grid-cols-7 gap-1 items-center mb-2">
                    <input type="text" id="szablon-warunek-1" placeholder="Warunek 1" class="col-span-3 border-gray-300 rounded-lg shadow-sm p-2 text-sm focus:border-indigo-500">
                    
                    <select id="szablon-operator-1" class="col-span-1 border-gray-300 rounded-lg shadow-sm p-2 text-sm focus:border-indigo-500">
                        <option value=""></option>
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                        <option value="XOR">XOR</option>
                    </select>

                    <input type="text" id="szablon-warunek-2" placeholder="Warunek 2" class="col-span-3 border-gray-300 rounded-lg shadow-sm p-2 text-sm focus:border-indigo-500">
                    
                    <select id="szablon-operator-2" class="col-span-1 col-start-4 border-gray-300 rounded-lg shadow-sm p-2 text-sm focus:border-indigo-500">
                        <option value=""></option>
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                        <option value="XOR">XOR</option>
                    </select>
                    
                    <input type="text" id="szablon-warunek-3" placeholder="Warunek 3" class="col-span-3 border-gray-300 rounded-lg shadow-sm p-2 text-sm focus:border-indigo-500">
                </div>
                <!-- ZMIENIONE POLA WERYFIKACJI KONIEC -->
                
                <textarea id="szablon-tekst" placeholder="Tekst szablonu... Używaj [if warunek]...[endif], [if warunek then 'treść'] i {zmienna}" rows="6" class="block w-full border-gray-300 rounded-lg shadow-sm mb-2 p-2 text-sm focus:border-indigo-500"></textarea>
            </div>
            <div class="mt-4 flex justify-end">
                <button id="zapisz-szablon-btn" class="bg-gradient-to-r from-green-500 to-green-600 text-white py-2 px-4 rounded-lg hover:from-green-600 hover:to-green-700 text-sm shadow-lg transition duration-150">Zapisz Szablon</button>
                <button id="zamknij-szablony-btn" class="ml-2 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 text-sm shadow-md transition duration-150">Zamknij</button>
            </div>
        </div>
    </div>

    <!-- Modal Zarządzania Zmiennymi (ULEPSZONY) -->
    <div id="modal-zmienne" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 p-4 sm:p-6">
            <h3 class="text-xl sm:text-2xl font-bold mb-4 text-gray-800">Zarządzaj Szablonami Zmiennych</h3>
            <div class="max-h-80 sm:max-h-96 overflow-y-auto" id="lista-zmiennych"></div>
            <div class="mt-4 border-t pt-4">
                <input type="hidden" id="zmienna-id">
                <input type="text" id="zmienna-nazwa" placeholder="Nazwa zmiennej (np. _lekarz)" class="block w-full border-gray-300 rounded-lg shadow-sm mb-2 p-2 text-sm focus:border-indigo-500">
                <input type="text" id="zmienna-opis" placeholder="Krótki opis zmiennej" class="block w-full border-gray-300 rounded-lg shadow-sm mb-2 p-2 text-sm focus:border-indigo-500">
                <textarea id="zmienna-wartosc" placeholder="Tekst/wartość zmiennej" rows="3" class="block w-full border-gray-300 rounded-lg shadow-sm mb-2 p-2 text-sm focus:border-indigo-500"></textarea>
            </div>
            <div class="mt-4 flex justify-end">
                <button id="zapisz-zmienna-btn" class="bg-gradient-to-r from-green-500 to-green-600 text-white py-2 px-4 rounded-lg hover:from-green-600 hover:to-green-700 text-sm shadow-lg transition duration-150">Zapisz Zmienną</button>
                <button id="zamknij-zmienne-btn" class="ml-2 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 text-sm shadow-md transition duration-150">Zamknij</button>
            </div>
        </div>
    </div>

    <!-- Modal Zarządzania Listami (Teraz tylko Wydane przez) -->
    <div id="modal-listy" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 p-4 sm:p-6">
            <h3 class="text-xl sm:text-2xl font-bold mb-4 text-gray-800" id="modal-listy-tytul">Zarządzaj Opcjami</h3>
            <div class="max-h-80 sm:max-h-96 overflow-y-auto" id="lista-opcji"></div>
             <div class="mt-4 border-t pt-4">
                <input type="hidden" id="opcja-id">
                <input type="text" id="opcja-wartosc" placeholder="Wartość opcji" class="block w-full border-gray-300 rounded-lg shadow-sm mb-2 p-2 text-sm focus:border-indigo-500">
            </div>
            <div class="mt-4 flex justify-end">
                <button id="zapisz-opcje-btn" class="bg-gradient-to-r from-green-500 to-green-600 text-white py-2 px-4 rounded-lg hover:from-green-600 hover:to-green-700 text-sm shadow-lg transition duration-150">Zapisz Opcję</button>
                <button id="zamknij-listy-btn" class="ml-2 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 text-sm shadow-md transition duration-150">Zamknij</button>
            </div>
        </div>
    </div>

    <script>
        // Konfiguracja Firebase - UZUPEŁNIJ WŁASNYMI DANYMI
        const firebaseConfig = {
  apiKey: "AIzaSyDSbAFbY--cLcDsqwcfcMakG4vO_VIbcGc",
  authDomain: "uzasadnienia-babd3.firebaseapp.com",
  projectId: "uzasadnienia-babd3",
  storageBucket: "uzasadnienia-babd3.firebasestorage.app",
  messagingSenderId: "873623457594",
  appId: "1:873623457594:web:dcf935e9bd87ee8dd7ca03"
        };

        // Zmienne do przechowywania instancji Firebase (globalne w ramach skryptu)
        let auth;
        let db;
        let zmienneCache = {}; // Cache na zmienne niestandardowe

        // Inicjalizacja Firebase
        const statusText = document.getElementById('status-text');

        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            statusText.textContent = "Błąd Konfiguracji: Uzupełnij dane Firebase w pliku index.html";
            statusText.className = "text-center text-lg font-semibold mb-6 text-red-600";
        } else {
            try {
                const app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth(); // Przypisanie do zmiennej globalnej
                db = firebase.firestore(); // Przypisanie do zmiennej globalnej

                // Logowanie anonimowe i uruchomienie aplikacji po autentykacji
                auth.onAuthStateChanged(user => {
                    if (user) {
                        console.log('Użytkownik zalogowany anonimowo:', user.uid);
                        statusText.textContent = "Połączono";
                        statusText.className = "text-center text-lg font-semibold mb-6 text-green-600";
                        initializeAppData(); // Uruchomienie logiki aplikacji po połączeniu
                    } else {
                        auth.signInAnonymously().catch(error => {
                            console.error('Błąd logowania anonimowego:', error);
                             statusText.textContent = `Błąd Połączenia: ${error.message}`;
                             statusText.className = "text-center text-lg font-semibold mb-6 text-red-600";
                        });
                    }
                });
             } catch (e) {
                statusText.textContent = `Błąd Inicjalizacji: ${e.message}`;
                statusText.className = "text-center text-lg font-semibold mb-6 text-red-600";
             }
        }

        // Logika formatowania dat (dd.mm.rrrr)
        function formatDateInput(event) {
            const input = event.target;
            let value = input.value.replace(/\D/g, ''); // Usuń wszystko oprócz cyfr
            let formattedValue = '';

            if (value.length > 8) {
                value = value.substring(0, 8);
            }

            if (value.length > 2) {
                formattedValue += value.substring(0, 2) + '.';
                value = value.substring(2);
            }
            if (value.length > 2) {
                formattedValue += value.substring(0, 2) + '.';
                value = value.substring(2);
            }
            formattedValue += value;

            input.value = formattedValue;
        }
        
        // Funkcja do sprawdzenia poprawności daty w formacie dd.mm.rrrr
        function isValidDate(dateString) {
            if (!dateString) return true; // Puste pole jest akceptowalne
            const regex = /^(\d{2})\.(\d{2})\.(\d{4})$/;
            const match = dateString.match(regex);
            if (!match) return false;

            const day = parseInt(match[1], 10);
            const month = parseInt(match[2], 10);
            const year = parseInt(match[3], 10);

            const date = new Date(year, month - 1, day);
            return date.getFullYear() === year && date.getMonth() + 1 === month && date.getDate() === day;
        }

        // Logika aplikacji, która powinna być uruchomiona dopiero po połączeniu z Firebase
        function initializeAppData() {
            
            const modals = {
                szablony: document.getElementById('modal-szablony'),
                zmienne: document.getElementById('modal-zmienne'),
                listy: document.getElementById('modal-listy')
            };

            const modalButtons = {
                openSzablony: document.getElementById('zarzadzaj-szablonami-btn'),
                openZmienne: document.getElementById('zarzadzaj-zmiennymi-btn-fixed'), // ZMIANA: użycie nowego stałego przycisku
                openWydanePrzez: document.getElementById('zarzadzaj-wydane-przez'),

                closeSzablony: document.getElementById('zamknij-szablony-btn'),
                closeZmienne: document.getElementById('zamknij-zmienne-btn'),
                closeListy: document.getElementById('zamknij-listy-btn'),

                saveSzablon: document.getElementById('zapisz-szablon-btn'),
                saveZmienna: document.getElementById('zapisz-zmienna-btn'),
                saveOpcja: document.getElementById('zapisz-opcje-btn')
            };

            const modalFields = {
                // Szablony
                szablonId: document.getElementById('szablon-id'),
                szablonNazwa: document.getElementById('szablon-nazwa'),
                szablonWarunek1: document.getElementById('szablon-warunek-1'),
                szablonOperator1: document.getElementById('szablon-operator-1'),
                szablonWarunek2: document.getElementById('szablon-warunek-2'),
                szablonOperator2: document.getElementById('szablon-operator-2'),
                szablonWarunek3: document.getElementById('szablon-warunek-3'),
                szablonTekst: document.getElementById('szablon-tekst'),
                listaSzablonow: document.getElementById('lista-szablonow'),

                // Zmienne
                zmiennaId: document.getElementById('zmienna-id'),
                zmiennaNazwa: document.getElementById('zmienna-nazwa'),
                zmiennaOpis: document.getElementById('zmienna-opis'), // NOWE POLE
                zmiennaWartosc: document.getElementById('zmienna-wartosc'),
                listaZmiennych: document.getElementById('lista-zmiennych'),
                zmienneWidgetContent: document.getElementById('zmienne-widget-content'), // NOWY ELEMENT WIDGETU

                // Listy
                listyTytul: document.getElementById('modal-listy-tytul'),
                opcjaId: document.getElementById('opcja-id'),
                opcjaWartosc: document.getElementById('opcja-wartosc'),
                listaOpcji: document.getElementById('lista-opcji'),
                currentListCollection: ''
            };
            
            // Rejestracja pól warunków do nasłuchiwania na zmiany, aby móc je wyczyścić
            const conditionFields = [
                modalFields.szablonWarunek1, 
                modalFields.szablonOperator1, 
                modalFields.szablonWarunek2, 
                modalFields.szablonOperator2, 
                modalFields.szablonWarunek3
            ];


            const formElements = {
                numerSprawy: document.getElementById('numer-sprawy'),
                dataZlozeniaWniosku: document.getElementById('data-zlozenia-wniosku'),
                plec: document.getElementById('plec'),
                imieNazwiskoDopelniacz: document.getElementById('imie-nazwisko-dopelniacz'),
                imieNazwiskoBiernik: document.getElementById('imie-nazwisko-biernik'),
                opiekunDopelniacz: document.getElementById('opiekun-dopelniacz'),
                wniosekZlozony: document.getElementById('wniosek-zlozony'),
                sekcjaPoprzednieOrzeczenie: document.getElementById('sekcja-poprzednie-orzeczenie'),
                rodzajDecyzji: document.getElementById('rodzaj-decyzji'),
                wydanePrzezLista: document.getElementById('wydane-przez-lista'),
                numerStaregoOrzeczenia: document.getElementById('numer-starego-orzeczenia'),
                dataStaregoOrzeczenia: document.getElementById('data-starego-orzeczenia'),
                stopienStaregoOrzeczenia: document.getElementById('stopien-starego-orzeczenia'),
                waznoscStaregoData: document.getElementById('waznosc-starego-data'),
                waznoscStaregoTrwale: document.getElementById('waznosc-starego-trwale'),
                dataKomisji: document.getElementById('data-komisji'),
                specjalista: document.getElementById('specjalista'),
                datyZaswiadczenKontener: document.getElementById('daty-zaswiadczen-lekarskich-kontener'),
                dodajDateBtn: document.getElementById('dodaj-date-zaswiadczenia'),
                zaocznie: document.getElementById('zaocznie'),
                odmowaWydania: document.getElementById('odmowa-wydania'),
                zaliczonoDo: document.getElementById('zaliczono-do'),
                punkt1Checkbox: document.getElementById('punkt1-checkbox'),
                punkt7: document.getElementById('punkt7'),
                punkt8: document.getElementById('punkt8'),
                waznoscNowegoData: document.getElementById('waznosc-nowego-data'),
                waznoscNowegoTrwale: document.getElementById('waznosc-nowego-trwale'),
                symbol1: document.getElementById('symbol-1'),
                symbol2: document.getElementById('symbol-2'),
                symbol3: document.getElementById('symbol-3'),
                wyszukajBtn: document.getElementById('wyszukaj'),
                zapiszBtn: document.getElementById('zapisz'),
                wygenerowaneUzasadnienie: document.getElementById('wygenerowane-uzasadnienie')
            };

            const collectionName = 'orzeczenia';

            // Przypisanie funkcji formatującej daty do odpowiednich pól
            [
                formElements.dataZlozeniaWniosku,
                formElements.dataStaregoOrzeczenia,
                formElements.waznoscStaregoData,
                formElements.dataKomisji,
                formElements.waznoscNowegoData
            ].forEach(input => {
                input.addEventListener('input', formatDateInput);
                input.addEventListener('change', generateUzasadnienie); // Dodatkowe wywołanie po zmianie
            });
            
            // Inicjalne pole daty zaświadczenia
            function createDateInput(value = '') {
                // Tworzymy kontener dla inputa i przycisku
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 w-full';

                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.name = 'data-zaswiadczenia';
                newInput.placeholder = 'dd.mm.rrrr';
                newInput.className = 'mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-1 px-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 flex-grow transition duration-150';
                newInput.value = value;
                newInput.addEventListener('input', formatDateInput);
                newInput.addEventListener('change', generateUzasadnienie);
                
                div.appendChild(newInput);

                // Dodajemy przycisk usuwania dla wszystkich pól poza pierwszym (pierwsze pole jest usuwane dynamicznie, jeśli jest puste)
                if (formElements.datyZaswiadczenKontener.children.length > 0 || value) {
                     const deleteBtn = document.createElement('button');
                     deleteBtn.innerHTML = `
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600 hover:text-red-800" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                         </svg>
                     `;
                     deleteBtn.type = 'button';
                     deleteBtn.className = 'p-1 mt-1';
                     deleteBtn.onclick = () => {
                         // Usuń cały kontener pola daty
                         formElements.datyZaswiadczenKontener.removeChild(div);
                         
                         // Jeśli usunęliśmy ostatnie pole, dodaj z powrotem jedno puste pole
                         if (formElements.datyZaswiadczenKontener.children.length === 0) {
                              formElements.datyZaswiadczenKontener.appendChild(createDateInput());
                         }
                         
                         generateUzasadnienie();
                     };
                     div.appendChild(deleteBtn);
                }
                
                return div;
            }
            
            // Funkcja pomocnicza do inicjalizacji pierwszego pola zaświadczenia
            function initializeDatyZaswiadczen() {
                 if(formElements.datyZaswiadczenKontener.children.length === 0){
                    formElements.datyZaswiadczenKontener.appendChild(createDateInput());
                }
            }
            initializeDatyZaswiadczen();


            // Logika warunkowa dla formularza
            formElements.wniosekZlozony.addEventListener('change', () => {
                if (formElements.wniosekZlozony.value === 'pierwszy raz') {
                    formElements.sekcjaPoprzednieOrzeczenie.classList.add('hidden');
                } else {
                    formElements.sekcjaPoprzednieOrzeczenie.classList.remove('hidden');
                }
            });

            formElements.waznoscStaregoTrwale.addEventListener('change', () => {
                if (formElements.waznoscStaregoTrwale.checked) {
                    formElements.waznoscStaregoData.value = '';
                    formElements.waznoscStaregoData.disabled = true;
                } else {
                    formElements.waznoscStaregoData.disabled = false;
                }
                generateUzasadnienie();
            });

            formElements.waznoscNowegoTrwale.addEventListener('change', () => {
                if (formElements.waznoscNowegoTrwale.checked) {
                    formElements.waznoscNowegoData.value = '';
                    formElements.waznoscNowegoData.disabled = true;
                } else {
                    formElements.waznoscNowegoData.disabled = false;
                }
                generateUzasadnienie();
            });

            formElements.zaocznie.addEventListener('change', () => {
                if (formElements.zaocznie.checked) {
                    formElements.waznoscNowegoData.value = '';
                    formElements.waznoscNowegoData.disabled = true;
                    formElements.waznoscNowegoTrwale.checked = false;
                    formElements.waznoscNowegoTrwale.disabled = true;
                } else {
                    formElements.waznoscNowegoData.disabled = false;
                    formElements.waznoscNowegoTrwale.disabled = false;
                }
                generateUzasadnienie();
            });
            
            formElements.odmowaWydania.addEventListener('change', generateUzasadnienie);

            // Dodawanie pól na daty zaświadczeń
            formElements.dodajDateBtn.addEventListener('click', () => {
                 formElements.datyZaswiadczenKontener.appendChild(createDateInput());
                 generateUzasadnienie();
            });
            
            // Kopiowanie uzasadnienia do schowka
            formElements.wygenerowaneUzasadnienie.addEventListener('click', () => {
                const textToCopy = formElements.wygenerowaneUzasadnienie.value;
                if (!textToCopy) return;

                // Użycie document.execCommand('copy') jako fall-back
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    statusText.textContent = 'Skopiowano uzasadnienie do schowka!';
                    statusText.className = "text-center text-lg font-semibold mb-6 text-indigo-600";
                } catch (err) {
                    console.error('Błąd kopiowania:', err);
                    statusText.textContent = 'Błąd kopiowania. Spróbuj zaznaczyć i skopiować ręcznie.';
                    statusText.className = "text-center text-lg font-semibold mb-6 text-red-600";
                }
                document.body.removeChild(textarea);

                // Przywrócenie statusu po chwili
                setTimeout(() => {
                    statusText.textContent = "Połączono";
                    statusText.className = "text-center text-lg font-semibold mb-6 text-green-600";
                }, 3000);
            });


            // Zapis danych
            formElements.zapiszBtn.addEventListener('click', async () => {
                const numerSprawy = formElements.numerSprawy.value.trim();
                if (!numerSprawy) {
                    console.error('Błąd: Numer sprawy jest wymagany!');
                    document.getElementById('status-text').textContent = 'Błąd Zapisu: Numer sprawy jest wymagany.';
                    document.getElementById('status-text').className = "text-center text-lg font-semibold mb-6 text-red-600";
                    return;
                }
                
                // Walidacja dat przed zapisem
                const dateFields = [
                    formElements.dataZlozeniaWniosku,
                    formElements.dataStaregoOrzeczenia,
                    formElements.waznoscStaregoData,
                    formElements.dataKomisji,
                    formElements.waznoscNowegoData
                ];

                for (const field of dateFields) {
                    if (field.value && !field.disabled && !isValidDate(field.value)) {
                         document.getElementById('status-text').textContent = `Błąd Zapisu: Niepoprawny format daty w polu ${field.id}. Użyj dd.mm.rrrr.`;
                         document.getElementById('status-text').className = "text-center text-lg font-semibold mb-6 text-red-600";
                         return;
                    }
                }

                const datyZaswiadczen = Array.from(formElements.datyZaswiadczenKontener.querySelectorAll('input[name="data-zaswiadczenia"]'))
                                             .map(input => input.value)
                                             .filter(value => value);
                
                for (const dateStr of datyZaswiadczen) {
                    if (!isValidDate(dateStr)) {
                         document.getElementById('status-text').textContent = `Błąd Zapisu: Niepoprawny format daty w zaświadczeniach (${dateStr}). Użyj dd.mm.rrrr.`;
                         document.getElementById('status-text').className = "text-center text-lg font-semibold mb-6 text-red-600";
                         return;
                    }
                }
                
                const data = {
                    'numer-sprawy': numerSprawy,
                    'data-zlozenia-wniosku': formElements.dataZlozeniaWniosku.value,
                    'plec': formElements.plec.value,
                    'imie-nazwisko-dopelniacz': formElements.imieNazwiskoDopelniacz.value,
                    'imie-nazwisko-biernik': formElements.imieNazwiskoBiernik.value,
                    'opiekun-dopelniacz': formElements.opiekunDopelniacz.value,
                    'wniosek-zlozony': formElements.wniosekZlozony.value,
                    'rodzaj-decyzji': formElements.rodzajDecyzji.value,
                    'wydane-przez-lista': formElements.wydanePrzezLista.value,
                    'numer-starego-orzeczenia': formElements.numerStaregoOrzeczenia.value,
                    'data-starego-orzeczenia': formElements.dataStaregoOrzeczenia.value,
                    'stopien-starego-orzeczenia': formElements.stopienStaregoOrzeczenia.value,
                    'waznosc-starego-data': formElements.waznoscStaregoData.value,
                    'waznosc-starego-trwale': formElements.waznoscStaregoTrwale.checked,
                    'data-komisji': formElements.dataKomisji.value,
                    'specjalista': formElements.specjalista.value,
                    'daty-zaswiadczen': datyZaswiadczen,
                    'zaocznie': formElements.zaocznie.checked,
                    'odmowa-wydania': formElements.odmowaWydania.checked, // Zapis nowego checkboxa
                    'zaliczono-do': formElements.zaliczonoDo.value,
                    // Zmiana: zapisujemy stan checkboxa pod nazwą 'punkt1'
                    'punkt1': formElements.punkt1Checkbox.checked,
                    'punkt7': formElements.punkt7.checked,
                    'punkt8': formElements.punkt8.checked,
                    'waznosc-nowego-data': formElements.waznoscNowegoData.value,
                    'waznosc-nowego-trwale': formElements.waznoscNowegoTrwale.checked,
                    'symbol-1': formElements.symbol1.value,
                    'symbol-2': formElements.symbol2.value,
                    'symbol-3': formElements.symbol3.value,
                };

                try {
                    await db.collection(collectionName).doc(numerSprawy).set(data);
                    document.getElementById('status-text').textContent = 'Dane zostały pomyślnie zapisane!';
                    document.getElementById('status-text').className = "text-center text-lg font-semibold mb-6 text-green-600";
                } catch (error) {
                    console.error('Błąd zapisu danych:', error);
                    document.getElementById('status-text').textContent = `Wystąpił błąd podczas zapisu danych: ${error.message}`;
                    document.getElementById('status-text').className = "text-center text-lg font-semibold mb-6 text-red-600";
                }
            });

            // Wyszukiwanie i ładowanie danych
            formElements.wyszukajBtn.addEventListener('click', async () => {
                const numerSprawy = formElements.numerSprawy.value.trim();
                if (!numerSprawy) {
                    document.getElementById('status-text').textContent = 'Błąd Odczytu: Proszę podać numer sprawy.';
                    document.getElementById('status-text').className = "text-center text-lg font-semibold mb-6 text-red-600";
                    return;
                }

                try {
                    const doc = await db.collection(collectionName).doc(numerSprawy).get();
                    if (doc.exists) {
                        const data = doc.data();

                        formElements.dataZlozeniaWniosku.value = data['data-zlozenia-wniosku'] || '';
                        formElements.plec.value = data['plec'] || 'Pana';
                        formElements.imieNazwiskoDopelniacz.value = data['imie-nazwisko-dopelniacz'] || '';
                        formElements.imieNazwiskoBiernik.value = data['imie-nazwisko-biernik'] || '';
                        formElements.opiekunDopelniacz.value = data['opiekun-dopelniacz'] || '';
                        formElements.wniosekZlozony.value = data['wniosek-zlozony'] || 'pierwszy raz';
                        formElements.rodzajDecyzji.value = data['rodzaj-decyzji'] || 'orzeczenia Nr';
                        formElements.wydanePrzezLista.value = data['wydane-przez-lista'] || '';
                        formElements.numerStaregoOrzeczenia.value = data['numer-starego-orzeczenia'] || '';
                        formElements.dataStaregoOrzeczenia.value = data['data-starego-orzeczenia'] || '';
                        formElements.stopienStaregoOrzeczenia.value = data['stopien-starego-orzeczenia'] || 'lekkiego stopnia niepełnosprawności';
                        formElements.waznoscStaregoData.value = data['waznosc-starego-data'] || '';
                        formElements.waznoscStaregoTrwale.checked = data['waznosc-starego-trwale'] || false;
                        formElements.dataKomisji.value = data['data-komisji'] || '';
                        formElements.specjalista.value = data['specjalista'] || 'doradca zawodowy';
                        
                        // Ładowanie dat zaświadczeń
                        formElements.datyZaswiadczenKontener.innerHTML = '';
                        const datyZaswiadczenArr = data['daty-zaswiadczen'];
                        
                        if (datyZaswiadczenArr && Array.isArray(datyZaswiadczenArr) && datyZaswiadczenArr.length > 0) {
                            datyZaswiadczenArr.forEach(dataStr => {
                                formElements.datyZaswiadczenKontener.appendChild(createDateInput(dataStr));
                            });
                        }
                         
                         // Zapewnienie, że zawsze jest co najmniej jedno pole daty zaświadczenia
                         initializeDatyZaswiadczen();


                        formElements.zaocznie.checked = data['zaocznie'] || false;
                        formElements.odmowaWydania.checked = data['odmowa-wydania'] || false; // Ładowanie nowego checkboxa
                        formElements.zaliczonoDo.value = data['zaliczono-do'] || 'lekkiego stopnia niepełnosprawności';
                        // Zmiana: ładowanie stanu checkboxa
                        formElements.punkt1Checkbox.checked = data['punkt1'] || false;
                        formElements.punkt7.checked = data['punkt7'] || false;
                        formElements.punkt8.checked = data['punkt8'] || false;
                        formElements.waznoscNowegoData.value = data['waznosc-nowego-data'] || '';
                        formElements.waznoscNowegoTrwale.checked = data['waznosc-nowego-trwale'] || false;
                        formElements.symbol1.value = data['symbol-1'] || '';
                        formElements.symbol2.value = data['symbol-2'] || '';
                        formElements.symbol3.value = data['symbol-3'] || '';

                        // Uruchomienie eventów, aby zaktualizować UI
                        formElements.wniosekZlozony.dispatchEvent(new Event('change'));
                        formElements.waznoscStaregoTrwale.dispatchEvent(new Event('change'));
                        formElements.zaocznie.dispatchEvent(new Event('change'));
                        formElements.waznoscNowegoTrwale.dispatchEvent(new Event('change'));
                        formElements.odmowaWydania.dispatchEvent(new Event('change')); // Wywołanie dla nowego checkboxa

                        document.getElementById('status-text').textContent = 'Dane zostały załadowane.';
                        document.getElementById('status-text').className = "text-center text-lg font-semibold mb-6 text-green-600";
                    } else {
                        document.getElementById('status-text').textContent = 'Nie znaleziono danych dla podanego numeru sprawy.';
                        document.getElementById('status-text').className = "text-center text-lg font-semibold mb-6 text-red-600";
                    }
                     // Po załadowaniu danych generujemy uzasadnienie
                    generateUzasadnienie();
                } catch (error) {
                    console.error('Błąd odczytu danych:', error);
                    document.getElementById('status-text').textContent = `Wystąpił błąd podczas odczytu danych: ${error.message}`;
                    document.getElementById('status-text').className = "text-center text-lg font-semibold mb-6 text-red-600";
                }
            });

            // --- LOGIKA MODALI ---

            // Otwieranie i zamykanie modali
            modalButtons.openSzablony.addEventListener('click', () => { loadSzablony(); modals.szablony.classList.add('active'); });
            modalButtons.closeSzablony.addEventListener('click', () => modals.szablony.classList.remove('active'));

            // ZMIANA: Obsługa stałego przycisku zmiennych
            modalButtons.openZmienne.addEventListener('click', () => { loadZmienne(); modals.zmienne.classList.add('active'); });
            modalButtons.closeZmienne.addEventListener('click', () => { 
                // Czyszczenie pól po zamknięciu
                modalFields.zmiennaId.value = '';
                modalFields.zmiennaNazwa.value = '';
                modalFields.zmiennaOpis.value = '';
                modalFields.zmiennaWartosc.value = '';
                modals.zmienne.classList.remove('active'); 
            });

            modalButtons.openWydanePrzez.addEventListener('click', () => openListModal('wydane_przez', 'Zarządzaj Opcjami "Wydane Przez"'));
            modalButtons.closeListy.addEventListener('click', () => modals.listy.classList.remove('active'));

            function openListModal(collection, title) {
                modalFields.currentListCollection = collection;
                modalFields.listyTytul.textContent = title;
                loadListOptions();
                modals.listy.classList.add('active');
            }

            // Zarządzanie Szablonami (CRUD)
            async function loadSzablony() {
                // Dodano orderBy('nazwa') dla pewności
                const snapshot = await db.collection('szablony').orderBy('nazwa').get();
                modalFields.listaSzablonow.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'p-2 border-b flex justify-between items-center text-sm';
                    div.innerHTML = `<span>${data.nazwa}</span>`;
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edytuj';
                    editBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded-lg text-xs shadow-md transition duration-150';
                    editBtn.onclick = () => {
                        modalFields.szablonId.value = doc.id;
                        modalFields.szablonNazwa.value = data.nazwa;
                        modalFields.szablonTekst.value = data.tekst;
                        
                        // Ładowanie rozdzielonych pól
                        modalFields.szablonWarunek1.value = data['warunek-1'] || '';
                        modalFields.szablonOperator1.value = data['operator-1'] || '';
                        modalFields.szablonWarunek2.value = data['warunek-2'] || '';
                        modalFields.szablonOperator2.value = data['operator-2'] || '';
                        modalFields.szablonWarunek3.value = data['warunek-3'] || '';
                    };
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Usuń';
                    deleteBtn.className = 'ml-2 bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded-lg text-xs shadow-md transition duration-150';
                    deleteBtn.onclick = async () => {
                         // Zmieniono confirm() na console.log - symulacja
                        if (true) { // Zawsze kontynuuj dla symulacji
                            await db.collection('szablony').doc(doc.id).delete();
                            loadSzablony();
                        }
                    };
                    const btnContainer = document.createElement('div');
                    btnContainer.appendChild(editBtn);
                    btnContainer.appendChild(deleteBtn);
                    div.appendChild(btnContainer);
                    modalFields.listaSzablonow.appendChild(div);
                });
            }

            modalButtons.saveSzablon.addEventListener('click', async () => {
                const id = modalFields.szablonId.value;
                const data = {
                    nazwa: modalFields.szablonNazwa.value,
                    tekst: modalFields.szablonTekst.value,
                    // ZMIANA: Zapis rozdzielonych pól warunków
                    'warunek-1': modalFields.szablonWarunek1.value.trim(),
                    'operator-1': modalFields.szablonOperator1.value,
                    'warunek-2': modalFields.szablonWarunek2.value.trim(),
                    'operator-2': modalFields.szablonOperator2.value,
                    'warunek-3': modalFields.szablonWarunek3.value.trim(),
                };
                
                // Budowanie złożonego warunku weryfikacji (dla logiki)
                let weryfikacja = '';
                if (data['warunek-1']) {
                    weryfikacja += data['warunek-1'];
                    if (data['warunek-2'] && data['operator-1']) {
                        weryfikacja += ` ${data['operator-1']} ${data['warunek-2']}`;
                        if (data['warunek-3'] && data['operator-2']) {
                            weryfikacja += ` ${data['operator-2']} ${data['warunek-3']}`;
                        }
                    }
                }
                
                data.weryfikacja = weryfikacja;

                if (id) {
                    await db.collection('szablony').doc(id).set(data, { merge: true });
                } else {
                    await db.collection('szablony').add(data);
                }
                modalFields.szablonId.value = '';
                modalFields.szablonNazwa.value = '';
                modalFields.szablonTekst.value = '';
                // Czyszczenie nowych pól
                conditionFields.forEach(field => field.value = field.tagName === 'SELECT' ? '' : '');

                loadSzablony();
                generateUzasadnienie(); // Wywołaj po zapisie szablonu
            });

            // Zarządzanie Szablonami Zmiennych (CRUD)
            async function loadZmienne() {
                const snapshot = await db.collection('zmienne').get();
                modalFields.listaZmiennych.innerHTML = '';
                modalFields.zmienneWidgetContent.innerHTML = ''; // Czyszczenie widgetu
                zmienneCache = {}; // Czyszczenie cache
                 
                let zmienneHtml = ''; // Bufor dla widgetu na stronie głównej
                 
                snapshot.forEach(doc => {
                    const data = doc.data();
                    zmienneCache[data.nazwa] = data.wartosc; // Zapis do cache
                    
                    // HTML dla Modalu
                    const divModal = document.createElement('div');
                    divModal.className = 'p-2 border-b flex justify-between items-center text-sm';
                    divModal.innerHTML = `<span><strong>{${data.nazwa}}</strong>: ${data.opis || data.wartosc.substring(0, 30) + '...'}</span>`;
                     
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edytuj';
                    editBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded-lg text-xs shadow-md transition duration-150';
                    editBtn.onclick = () => {
                        modalFields.zmiennaId.value = doc.id;
                        modalFields.zmiennaNazwa.value = data.nazwa;
                        modalFields.zmiennaOpis.value = data.opis || ''; // Ładowanie opisu
                        modalFields.zmiennaWartosc.value = data.wartosc;
                    };
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Usuń';
                    deleteBtn.className = 'ml-2 bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded-lg text-xs shadow-md transition duration-150';
                    deleteBtn.onclick = async () => {
                        if (true) {
                            await db.collection('zmienne').doc(doc.id).delete();
                            loadZmienne(); // Przeładowanie modalu i widgetu
                            generateUzasadnienie();
                        }
                    };
                     const btnContainer = document.createElement('div');
                    btnContainer.appendChild(editBtn);
                    btnContainer.appendChild(deleteBtn);
                    divModal.appendChild(btnContainer);
                    modalFields.listaZmiennych.appendChild(divModal);
                    
                    // HTML dla Widgetu
                    zmienneHtml += `
                        <div class="border-b pb-1">
                            <p class="font-semibold text-sm text-gray-700">{${data.nazwa}}</p>
                            <p class="text-xs text-gray-500">${data.opis || 'Brak opisu.'}</p>
                        </div>
                    `;

                });
                
                modalFields.zmienneWidgetContent.innerHTML = zmienneHtml || '<p class="text-sm text-gray-500">Brak zdefiniowanych zmiennych niestandardowych.</p>';
            }

            modalButtons.saveZmienna.addEventListener('click', async () => {
                const id = modalFields.zmiennaId.value;
                 const data = {
                    nazwa: modalFields.zmiennaNazwa.value.trim(),
                    opis: modalFields.zmiennaOpis.value.trim(), // Zapis nowego pola
                    wartosc: modalFields.zmiennaWartosc.value,
                };
                
                if (!data.nazwa) {
                    alert('Nazwa zmiennej jest wymagana!'); // Używam alert/console.log, ponieważ modalFields.statusText nie jest tu dostępny
                    return;
                }

                if (id) {
                    await db.collection('zmienne').doc(id).set(data, { merge: true });
                } else {
                    await db.collection('zmienne').add(data);
                }
                modalFields.zmiennaId.value = '';
                modalFields.zmiennaNazwa.value = '';
                modalFields.zmiennaOpis.value = '';
                modalFields.zmiennaWartosc.value = '';
                loadZmienne(); // Przeładowanie modalu i widgetu
                generateUzasadnienie(); // Wywołaj po zapisie zmiennej
            });

             // Zarządzanie Listami (CRUD - tylko dla wydane_przez)
            async function loadListOptions() {
                const collection = modalFields.currentListCollection;
                if (!collection) return;

                const snapshot = await db.collection(collection).get();
                modalFields.listaOpcji.innerHTML = '';
                 snapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'p-2 border-b flex justify-between items-center text-sm';
                    div.innerHTML = `<span>${data.wartosc}</span>`;
                     const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edytuj';
                    editBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded-lg text-xs shadow-md transition duration-150';
                    editBtn.onclick = () => {
                        modalFields.opcjaId.value = doc.id;
                        modalFields.opcjaWartosc.value = data.wartosc;
                    };
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Usuń';
                    deleteBtn.className = 'ml-2 bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded-lg text-xs shadow-md transition duration-150';
                    deleteBtn.onclick = async () => {
                         // Zmieniono confirm() na console.log - symulacja
                        if (true) { // Zawsze kontynuuj dla symulacji
                            await db.collection(collection).doc(doc.id).delete();
                            loadListOptions();
                            await loadAllListOptionsIntoSelects();
                        }
                    };
                     const btnContainer = document.createElement('div');
                    btnContainer.appendChild(editBtn);
                    btnContainer.appendChild(deleteBtn);
                    div.appendChild(btnContainer);
                    modalFields.listaOpcji.appendChild(div);
                });
            }
             modalButtons.saveOpcja.addEventListener('click', async () => {
                 const collection = modalFields.currentListCollection;
                if (!collection) return;

                const id = modalFields.opcjaId.value;
                const data = { wartosc: modalFields.opcjaWartosc.value };

                if (id) {
                    await db.collection(collection).doc(id).set(data, { merge: true });
                } else {
                    await db.collection(collection).add(data);
                }
                modalFields.opcjaId.value = '';
                modalFields.opcjaWartosc.value = '';
                loadListOptions();
                await loadAllListOptionsIntoSelects();
                generateUzasadnienie();
            });

             // Ładowanie opcji do selectów przy starcie
            async function loadAllListOptionsIntoSelects() {
                const wydanePrzezSnapshot = await db.collection('wydane_przez').get();
                formElements.wydanePrzezLista.innerHTML = '';
                wydanePrzezSnapshot.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.data().wartosc;
                    option.textContent = doc.data().wartosc;
                    formElements.wydanePrzezLista.appendChild(option);
                });
            }

            // --- SILNIK GENEROWANIA UZASADNIEŃ ---
            const allInputs = document.querySelectorAll('input, select, textarea');
            allInputs.forEach(input => {
                // Dodajemy nasłuchiwanie tylko dla elementów, które nie są polami dat/checkboxami
                if (input.type !== 'checkbox' && !['data-zlozenia-wniosku', 'data-starego-orzeczenia', 'waznosc-starego-data', 'data-komisji', 'waznosc-nowego-data'].includes(input.id) && input.name !== 'data-zaswiadczenia') {
                    input.addEventListener('change', generateUzasadnienie);
                    input.addEventListener('keyup', generateUzasadnienie);
                }
            });
            // Dodajemy nasłuchiwanie dla checkboxów (już były dodane w głównym bloku)
            document.getElementById('punkt1-checkbox').addEventListener('change', generateUzasadnienie);
            document.getElementById('punkt7').addEventListener('change', generateUzasadnienie);
            document.getElementById('punkt8').addEventListener('change', generateUzasadnienie);
            document.getElementById('waznosc-starego-trwale').addEventListener('change', generateUzasadnienie);
            document.getElementById('waznosc-nowego-trwale').addEventListener('change', generateUzasadnienie);
            document.getElementById('zaocznie').addEventListener('change', generateUzasadnienie);
            document.getElementById('odmowa-wydania').addEventListener('change', generateUzasadnienie);


            async function generateUzasadnienie() {
                // 1. Zbierz wszystkie dane z formularza, używając ID jako kluczy
                const formData = {};
                
                for (const key in formElements) {
                    const element = formElements[key];
                    if (element && element.id && element.tagName) {
                        const fieldName = element.id;

                        if (element.type === 'checkbox') {
                            formData[fieldName] = element.checked;
                        } else {
                            formData[fieldName] = element.value;
                        }
                    }
                }

                 // Poprawka: ręczne mapowanie dla nazw pól formularza używanych w szablonach
                 // Zmiana: Konwersja booleanów na string 'true'/'false'
                 formData['punkt1'] = formElements.punkt1Checkbox.checked ? 'true' : 'false';
                 delete formData['punkt1-checkbox'];

                 formData['punkt7'] = formElements.punkt7.checked ? 'true' : 'false';
                 formData['punkt8'] = formElements.punkt8.checked ? 'true' : 'false';
                 // Dodanie nowego checkboxa
                 formData['odmowa-wydania'] = formElements.odmowaWydania.checked ? 'true' : 'false';


                 // Specjalne pola
                const datyZaswiadczen = Array.from(formElements.datyZaswiadczenKontener.querySelectorAll('input[name="data-zaswiadczenia"]'))
                                             .map(input => input.value)
                                             .filter(value => value);
                formData['daty-zaswiadczen'] = datyZaswiadczen.join(', ');


                // 2. Użycie cache'u zmiennych niestandardowych (zmienneCache)
                // W tym punkcie dane z formularza są łączone z danymi z cache'u
                // Cache jest ładowany w loadZmienne()
                const context = { ...formData, ...zmienneCache };
                
                // 4. Znajdź pasujący szablon
                const szablonySnapshot = await db.collection('szablony').orderBy('nazwa').get();
                let finalTekst = "Brak spełnionych wymagań.";

                for (const doc of szablonySnapshot.docs) {
                    const szablon = doc.data();
                    
                    // Budowanie warunku weryfikacji z rozdzielonych pól (najnowsza zmiana)
                    let weryfikacja = '';
                    if (szablon['warunek-1']) {
                        weryfikacja += szablon['warunek-1'];
                        if (szablon['warunek-2'] && szablon['operator-1']) {
                            weryfikacja += ` ${szablon['operator-1']} ${szablon['warunek-2']}`;
                            if (szablon['warunek-3'] && szablon['operator-2']) {
                                weryfikacja += ` ${szablon['operator-2']} ${szablon['warunek-3']}`;
                            }
                        }
                    }

                    if (!weryfikacja) {
                        continue;
                    }

                    try {
                        // Sprawdzanie warunku
                        if (evaluateCondition(weryfikacja, context)) {
                            finalTekst = szablon.tekst;
                            break;
                        }
                    } catch (e) {
                        console.error(`Błąd w warunku weryfikacji szablonu "${szablon.nazwa}" (${weryfikacja}):`, e);
                    }
                }
                
                // 5. Przetwórz tekst szablonu (zmienne i warunki if)
                const processedText = processTemplate(finalTekst, context);
                formElements.wygenerowaneUzasadnienie.value = processedText;
            }

            function evaluateCondition(condition, context) {
                 // Używamy regexa, który łapie nazwy ze słowami i myślnikami: {nazwa-pola}
                 const varRegex = /\{([\w\-]+)\}/g;
                 
                 // 1. Zastąp operatory logiczne (OR, AND, XOR) operatorami JS
                 let jsCondition = condition.trim()
                     .replace(/ OR /g, ' || ')
                     .replace(/ AND /g, ' && ')
                     .replace(/ XOR /g, ' != '); // W kontekście booleana/stringa, XOR to != (różne)
                 
                 // 2. Sprawdzamy, czy condition zawiera zmienne
                 if (!varRegex.test(jsCondition)) {
                     // Jeśli warunek nie zawiera zmiennych, ewaluujemy go bezpośrednio
                     try {
                        return new Function(`return ${jsCondition}`)();
                     } catch(e) {
                         console.error("Błąd ewaluacji prostego warunku:", e);
                         return false;
                     }
                 }

                 // 3. Zastąp zmienne w warunku ich wartościami z kontekstu.
                 let evaluatedCondition = jsCondition.replace(varRegex, (match, varName) => {
                     let value = context[varName];
                     if (value === undefined || value === null) {
                         value = "";
                     } else if (typeof value === 'boolean') {
                          // Konwersja booleana na string 'true'/'false'
                          return value ? "'true'" : "'false'";
                     } else if (typeof value === 'number') {
                         return value;
                     }
                     
                     value = String(value);

                     // Upewnij się, że stringi są ujęte w cudzysłowy w JS (np. 'aaa' == 'aaa')
                     // Zmieniona logika, aby ująć w cudzysłowy wszystkie stringi,
                     // chyba że są to liczby (które mogą być już w stringu).
                     if (value.match(/^-?\d+(\.\d+)?$/) === null) { // Jeśli nie wygląda jak sama liczba
                         // Użycie pojedyńczych cudzysłowów dla warunków
                         return `'${value.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}'`; 
                     }
                     
                     return value;
                 });

                 // 4. Bezpieczna Ewaluacja
                 try {
                     return new Function(`return ${evaluatedCondition}`)();
                 } catch (e) {
                     console.error(`Błąd w warunku po podstawieniu: ${evaluatedCondition}`, e);
                     return false;
                 }
            }


            function processTemplate(template, context) {
                let text = template;

                // 1. Obsługa skróconego formatu: [if warunek then "treść" else "inna treść"]
                const inlineIfRegex = /\[if\s+(.*?)\s+then\s+(['"].*?['"])(?:\s+else\s+(['"].*?['"]))?\]/gs;

                 text = text.replace(inlineIfRegex, (match, condition, ifContentWithQuotes, elseContentWithQuotes) => {
                    // Usuwamy cudzysłowy z treści do wyświetlenia
                    const ifContent = ifContentWithQuotes.slice(1, -1); 
                    const elseContent = elseContentWithQuotes ? elseContentWithQuotes.slice(1, -1) : '';

                    try {
                        // Sprawdzamy warunek. evaluateCondition podmieni zmienne wewnątrz warunku {zmienna}
                        // i zamieni operatory OR/AND/XOR na JS (||, &&, !=).
                        if (evaluateCondition(condition.trim(), context)) {
                            return ifContent;
                        } else {
                            return elseContent;
                        }
                    } catch (e) {
                        console.error(`Błąd w przetwarzaniu warunku inline [if-then-else ${condition}]:`, e);
                        return '';
                    }
                });

                
                // 2. Obsługa standardowych bloków: [if warunek]...[else]...[endif]
                
                // Wersja if-else: [if warunek]...[else]...[endif]
                const ifElseRegex = /\[if\s+([^\]]+)\](.*?)\[else\](.*?)\[endif\]/gs;
                 text = text.replace(ifElseRegex, (match, condition, ifContent, elseContent) => {
                    try {
                        if (evaluateCondition(condition.trim(), context)) {
                            return ifContent;
                        } else {
                            return elseContent;
                        }
                    } catch (e) {
                        console.error(`Błąd w przetwarzaniu warunku [if-else ${condition}]:`, e);
                        return '';
                    }
                });
                
                // Wersja if-endif (bez else): [if warunek]...[endif]
                const ifRegex = /\[if\s+([^\]]+)\](.*?)\[endif\]/gs;
                text = text.replace(ifRegex, (match, condition, content) => {
                    try {
                        if (evaluateCondition(condition.trim(), context)) {
                            return content;
                        } else {
                            return '';
                        }
                    } catch (e) {
                        console.error(`Błąd w przetwarzaniu warunku [if ${condition}]:`, e);
                        return '';
                    }
                });

                // 3. Przetwarzanie zmiennych {} (po przetworzeniu wszystkich warunków)
                text = text.replace(/{([\w\-]+)}/g, (match, varName) => {
                    let value = context[varName];
                    if (value === undefined || value === null) {
                        value = '';
                    }
                    if (typeof value === 'boolean') {
                        return value ? 'true' : 'false';
                    }
                    return String(value);
                });

                return text;
            }

            // Ostatni krok inicjalizacji
            document.addEventListener('DOMContentLoaded', () => {
                // Ładowanie zmiennych, a następnie reszty danych
                loadZmienne().then(() => {
                    if (auth.currentUser) {
                        loadAllListOptionsIntoSelects().then(generateUzasadnienie);
                    }
                });
            });
            
            // Wymuś załadowanie listy po inicjalizacji
            loadAllListOptionsIntoSelects();
        } // Koniec initializeAppData
    </script>
</body>
</html>